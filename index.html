<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaHunt - AI Lead Hunter</title>
    <meta name="description" content="NovaHunt.ai: AI-powered tool to hunt B2B leads, emails, and suppliers with precision.">
    <meta name="keywords" content="AI lead generation, B2B leads, email hunter, supplier finder">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¥·</text></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=1.1.2" />
    <style>
        :root {
            --bg-color: #1A202C;
            --text-color: #E2E8F0;
            --secondary-text: #A0AEC0;
            --accent-color: #00FFCC;
            --card-bg: #2D3748;
            --border-color: #4A5568;
        }
        [data-theme="light"] {
            --bg-color: #FFFFFF;
            --text-color: #1A202C;
            --secondary-text: #718096;
            --accent-color: #00CC99;
            --card-bg: #F7FAFC;
            --border-color: #CBD5E0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-color); color: var(--text-color); line-height: 1.6; transition: all 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .section { padding: 60px 0; background: var(--bg-color); }
        h1 { font-size: 2.8em; font-weight: 800; text-align: center; color: var(--accent-color); margin-bottom: 15px; text-shadow: 0 0 10px var(--accent-color); }
        h2 { font-size: 2em; font-weight: 700; color: var(--text-color); margin-bottom: 20px; text-align: center; }
        p { font-size: 1.1em; color: var(--secondary-text); margin-bottom: 20px; text-align: center; }
        .btn { background: var(--accent-color); color: var(--bg-color); padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; text-decoration: none; display: inline-block; }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }
        .btn-primary { background: var(--accent-color); color: var(--bg-color); font-size: 1em; padding: 10px 20px; border-radius: 6px; }
        .btn-inline { padding: 4px 8px; font-size: 0.8em; margin: 0 5px; }
        .search-tabs { display: flex; background: var(--card-bg); border-radius: 6px; overflow: hidden; margin-bottom: 20px; justify-content: center; }
        .tab-btn { flex: 1; padding: 12px; background: transparent; color: var(--text-color); border: none; cursor: pointer; font-size: 1em; transition: background 0.3s; }
        .tab-btn.active { background: var(--accent-color); color: var(--bg-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .results { margin-top: 20px; }
        .result-item { background: var(--card-bg); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .loading { color: #90CDF4; font-style: italic; text-align: center; }
        .summary-box { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 10px var(--accent-color); }
        .pagination { text-align: center; margin-top: 10px; }
        .pagination button { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 5px 10px; margin: 0 5px; cursor: pointer; }
        .pagination button:hover { background: var(--border-color); }
        .pagination button.active { background: var(--accent-color); color: var(--bg-color); }
        .department-header { font-size: 1.2em; font-weight: 600; color: var(--text-color); margin: 10px 0 5px; }
        .premium-note { font-size: 0.8em; color: #90CDF4; margin-top: 10px; text-align: center; padding-bottom: 20px; }
        .error { color: #FC8181; font-size: 1em; margin-top: 10px; text-align: center; font-weight: bold; padding: 10px; background: var(--card-bg); border-radius: 4px; }
        .filter-group { margin-bottom: 10px; display: flex; gap: 10px; justify-content: center; }
        .filter-group select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color); }
        .toggle-group { display: none; }
        #map { height: 400px; width: 100%; margin-top: 40px; border: 2px solid var(--accent-color); border-radius: 6px; position: relative; }
        .map-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--secondary-text); font-style: italic; }
        .plans-section { padding: 40px 0; }
        .plan-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin: 15px; text-align: center; max-width: 250px; display: inline-block; vertical-align: top; box-shadow: 0 0 10px var(--accent-color); }
        .plan-card h3 { color: var(--accent-color); margin-bottom: 10px; }
        .plan-card ul { list-style: none; padding: 0; }
        .plan-card ul li { margin: 10px 0; color: var(--secondary-text); }
        .plan-card .price { font-size: 1.5em; color: var(--text-color); margin: 10px 0; }
        .plan-card .btn { margin-top: 15px; }
        .back-button { text-align: center; margin: 20px 0; }
        .upgrade-message { color: #FC8181; text-align: center; margin-top: 20px; font-weight: bold; }
        .badge { background: #FFCC00; color: var(--bg-color); padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .test-mode-toggle { text-align: center; margin: 10px 0; }
        .test-mode-toggle input { margin-right: 5px; }
        .nav { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .nav .user-info, .nav button, .nav a { display: inline-block; margin-right: 10px; }
        .tour-btn { position: fixed; bottom: 20px; right: 20px; background: var(--accent-color); color: var(--bg-color); padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .tour-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }
        .password-toggle { cursor: pointer; margin-left: 5px; color: var(--accent-color); }
        .dashboard { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 10px var(--accent-color); text-align: center; }
        .suggestions { color: #90CDF4; cursor: pointer; margin-top: 5px; font-size: 0.9em; }
        .suggestions div { margin-bottom: 5px; }
        .theme-toggle { text-align: center; margin: 10px 0; }
        .theme-toggle input { margin-right: 5px; }
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            .search-tabs { flex-direction: column; }
            .result-table { display: block; overflow-x: auto; }
            #map { height: 250px; margin-top: 30px; }
            .plan-card { max-width: 100%; margin: 10px 0; }
            .filter-group { flex-direction: column; }
            .tour-btn { bottom: 10px; right: 10px; }
            .nav { top: 10px; right: 10px; }
        }
    </style>
</head>
<body>
    <section class="section" style="padding-top: 80px; box-shadow: 0 4px 20px rgba(0, 255, 204, 0.3);">
        <div class="container">
            <h1>ðŸ¥· NovaHunt</h1>
            <p style="font-size: 1.2em;">AI-Powered Lead Generation That Hunts for You</p>
            <p>Redefine B2B success with cutting-edge AI precision.</p>
            <div style="text-align: center; margin-top: 20px;">
                <a href="https://buy.stripe.com/test_3cI7sLbl5dgI1ma5TL00002" class="btn btn-primary">Subscribe to Pro ($29/month)</a>
                <a href="https://buy.stripe.com/test_aFacN59cX0tWgh4ci900001" class="btn btn-primary">Business ($59/month)</a>
                <a href="https://buy.stripe.com/test_fZu5kD88T3G85Cqbe500000" class="btn btn-primary">Enterprise ($99/month)</a>
            </div>
            <p style="font-size: 0.9em; color: #90CDF4;">Free credits â€¢ No credit card required</p>
            <div class="test-mode-toggle">
                <input type="checkbox" id="testMode" onchange="toggleTestMode()">
                <label for="testMode">Enable Test Mode (Business/Enterprise Access)</label>
            </div>
            <div class="theme-toggle">
                <input type="checkbox" id="themeSwitch" onchange="toggleTheme()">
                <label for="themeSwitch">Switch to Light Theme</label>
            </div>
        </div>
    </section>

    <div class="nav" id="navLinks">
        <!-- Buttons will populate here on load -->
    </div>

    <section class="section">
        <div class="container">
            <h2>Search for Leads</h2>
            <p>Unleash NovaHuntâ€™s power across multiple modes.</p>
            <div class="search-tabs">
                <button class="tab-btn active" onclick="switchTab('company', this)">Hunt Corporate Emails</button>
                <button class="tab-btn" onclick="switchTab('ai', this)">Hunt Industry Leads</button>
                <button class="tab-btn" onclick="switchTab('imports', this)">Hunt Import Records</button>
            </div>
            <div id="company-tab" class="tab-content active">
                <p style="text-align: center; opacity: 0.8;">Enter a company name or domain (e.g., coca-cola.com).</p>
                <div class="filter-group">
                    <select id="departmentFilter" onchange="searchCompany()">
                        <option value="all">All Departments</option>
                        <option value="marketing">Marketing</option>
                        <option value="sales">Sales</option>
                        <option value="it">IT</option>
                        <option value="hr">HR</option>
                    </select>
                    <select id="roleFilter" onchange="searchCompany()">
                        <option value="all">All Roles</option>
                        <option value="manager">Manager</option>
                        <option value="director">Director</option>
                        <option value="specialist">Specialist</option>
                    </select>
                </div>
                <input type="text" id="companyInput" placeholder="Company or domain..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);">
                <div id="companyError" class="error" style="display: none;"></div>
                <button class="btn-primary" onclick="searchCompany()">Find Emails & Contacts</button>
                <div id="companyResults" class="results"></div>
            </div>
            <div id="ai-tab" class="tab-content">
                <p style="text-align: center; opacity: 0.8;">Ask me anything (e.g., 'Find marketing managers in tech USA')</p>
                <input type="text" id="aiInput" placeholder="Type your query..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);" oninput="showSuggestions()">
                <div id="suggestions" class="suggestions"></div>
                <button class="btn" onclick="searchAIConversational()">Get AI Leads</button>
                <div id="aiResults" class="results"></div>
            </div>
            <div id="imports-tab" class="tab-content">
                <!-- Populated by checkAccess -->
            </div>
        </div>
    </section>

    <button class="tour-btn" onclick="startTour()">Take a Tour</button>

    <footer style="text-align: center; padding: 20px 0; color: var(--secondary-text); background: var(--bg-color);">
        Â© 2025 NovaHunt.ai | All rights reserved | <a href="terms.html" style="color: var(--accent-color); text-decoration: none;">Terms</a> | <a href="privacy.html" style="color: var(--accent-color); text-decoration: none;">Privacy</a> | <a href="plans.html" style="color: var(--accent-color); text-decoration: none;">Plans</a> | <a href="faq.html" style="color: var(--accent-color); text-decoration: none;">FAQ</a>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=1.1.2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Script loaded at v25:', new Date().toLocaleTimeString());
            let firebase = null;
            let auth = null;
            let db = null;
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyArKU9HQx7An_PhRM2jlzIHVnLp1EmISlA",
                    authDomain: "novahunt-web-app-v2.firebaseapp.com",
                    projectId: "novahunt-web-app-v2",
                    storageBucket: "novahunt-web-app-v2.firebasestorage.app",
                    messagingSenderId: "915754711081",
                    appId: "1:915754711081:web:f563cc734c901812954438"
                };
                firebase = window.firebase || (window.firebase = {});
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log('Firebase initialized successfully');
            } catch (e) {
                console.error('Firebase initialization failed:', e);
                const navLinks = document.getElementById('navLinks');
                if (navLinks) navLinks.innerHTML = '<a href="login.html" class="btn">Sign In</a><a href="signup.html" class="btn">Sign Up</a><a href="plans.html" class="btn">Plans</a>';
                return;
            }

            let userCredits = 5;
            let isPremium = false;
            let isTestMode = false;
            let map;

            const urlParams = new URLSearchParams(window.location.search);
            const plan = urlParams.get('plan');
            const success = urlParams.get('success');
            if (success === 'true' && plan && auth.currentUser) {
                const user = auth.currentUser;
                const credits = { pro: 100, business: 250, enterprise: 9999 }[plan] || 5;
                db.doc(`users/${user.uid}`).set({
                    isPremium: true,
                    plan: plan,
                    monthlyCredits: { month: new Date().toISOString().slice(0, 7), credits: credits }
                }, { merge: true }).then(() => {
                    alert(`Welcome! Your ${plan} plan is activated.`);
                    window.location.href = 'index.html';
                });
            }

            auth.onAuthStateChanged(async (user) => {
                console.log('Auth state changed at:', new Date().toLocaleTimeString(), 'user:', user ? user.email : 'null');
                if (user) {
                    try {
                        await checkSubscriptionStatus(user.uid);
                        userCredits = await loadUserCredits(user.uid);
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        isPremium = false;
                        userCredits = 5;
                    }
                } else {
                    isPremium = false;
                    userCredits = 5;
                    isTestMode = false;
                }
                updateUI(user);
            });

            function updateUI(user) {
                console.log('Updating UI, user:', user ? user.email : 'null');
                const navLinks = document.getElementById('navLinks');
                if (!navLinks) {
                    console.error('navLinks element not found at:', new Date().toLocaleTimeString());
                    return;
                }
                if (user) {
                    navLinks.innerHTML = `
                        <div class="user-info">Logged in as: ${user.email}</div>
                        <button class="btn" onclick="logout()">Logout</button>
                        <a href="plans.html" class="btn">Plans</a>
                    `;
                    document.querySelectorAll('.dashboard').forEach(d => d.remove());
                    showDashboard(user);
                } else {
                    navLinks.innerHTML = `
                        <a href="login.html" class="btn">Sign In</a>
                        <a href="signup.html" class="btn">Sign Up</a>
                        <a href="plans.html" class="btn">Plans</a>
                    `;
                    document.querySelectorAll('.dashboard').forEach(d => d.remove());
                }
                checkAccess();
            }

            async function showDashboard(user) {
                const dashboard = document.createElement('div');
                dashboard.className = 'dashboard';
                dashboard.id = 'dashboard';
                const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]').slice(0, 3).join(', ') || 'None';
                dashboard.innerHTML = `
                    <h3>Dashboard</h3>
                    <p>Credits Left: <span id="credits">${userCredits}</span></p>
                    <p>Plan: ${isPremium ? 'Enterprise' : 'Free'}</p>
                    <p>Recent Searches: ${recentSearches}</p>
                `;
                document.body.insertBefore(dashboard, document.querySelector('section.section'));
            }

            function updateDashboardCredits() {
                const creditsSpan = document.getElementById('credits');
                if (creditsSpan) creditsSpan.textContent = userCredits;
                if (auth.currentUser) {
                    document.querySelectorAll('.dashboard').forEach(d => d.remove());
                    showDashboard(auth.currentUser);
                }
            }

            function logout() {
                auth.signOut().then(() => {
                    updateUI(null);
                    isTestMode = false;
                    isPremium = false;
                    alert('Logged out successfully!');
                }).catch((error) => alert('Error logging out: ' + error.message));
            }
            window.logout = logout;

            function toggleTestMode() {
                isTestMode = document.getElementById('testMode').checked;
                console.log(`Test mode ${isTestMode ? 'enabled' : 'disabled'} at v25:`, new Date().toLocaleTimeString());
                alert(`Test mode ${isTestMode ? 'enabled' : 'disabled'}. Premium features ${isTestMode ? 'available' : 'restricted'}.`);
                checkAccess();
            }
            window.toggleTestMode = toggleTestMode;

            async function checkSubscriptionStatus(uid) {
                console.log('Checking subscription for UID:', uid);
                const userRef = db.doc('users/' + uid);
                try {
                    const docSnap = await userRef.get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        console.log('Firestore data for UID', uid, ':', JSON.stringify(data));
                        isPremium = data.isPremium === true || (data.plan && data.plan.toLowerCase() === 'enterprise');
                        if (!data.isPremium && data.plan === 'enterprise') {
                            await userRef.set({ isPremium: true }, { merge: true });
                            isPremium = true;
                        }
                        if (uid === 'wCw6JFwAUzLh9cSmYVYkcZEUzRv2' && (!data.plan || data.plan !== 'enterprise')) {
                            await userRef.set({
                                isPremium: true,
                                plan: 'enterprise',
                                monthlyCredits: { month: new Date().toISOString().slice(0, 7), credits: 9999 }
                            }, { merge: true });
                            isPremium = true;
                        }
                    } else {
                        isPremium = false;
                        if (uid === 'wCw6JFwAUzLh9cSmYVYkcZEUzRv2') {
                            await userRef.set({
                                isPremium: true,
                                plan: 'enterprise',
                                monthlyCredits: { month: new Date().toISOString().slice(0, 7), credits: 9999 }
                            }, { merge: true });
                            isPremium = true;
                        }
                    }
                } catch (error) {
                    console.error('Error checking subscription:', error);
                    isPremium = false;
                }
                checkAccess();
            }
            window.checkSubscriptionStatus = checkSubscriptionStatus;

            function checkAccess() {
                console.log('checkAccess called at v25:', new Date().toLocaleTimeString(), 'isTestMode:', isTestMode, 'isPremium:', isPremium, 'user:', auth.currentUser ? auth.currentUser.email : 'null');
                const aiTab = document.getElementById('ai-tab');
                const importsTab = document.getElementById('imports-tab');
                if (!aiTab || !importsTab) {
                    console.log('Tab elements not found');
                    return;
                }
                if (!isTestMode && !isPremium && !auth.currentUser) {
                    aiTab.innerHTML = '<div class="upgrade-message">Please <a href="login.html" class="btn">Sign In</a> or <a href="signup.html" class="btn">Sign Up</a> to access this feature.</div>';
                    importsTab.innerHTML = '<div class="upgrade-message">Please <a href="login.html" class="btn">Sign In</a> or <a href="signup.html" class="btn">Sign Up</a> to access this feature.</div>';
                } else if (!isTestMode && !isPremium && auth.currentUser) {
                    aiTab.innerHTML = '<div class="upgrade-message">This feature is for Business/Enterprise users. <a href="plans.html" class="btn">Upgrade Now</a></div>';
                    importsTab.innerHTML = '<div class="upgrade-message">This feature is for Business/Enterprise users. <a href="plans.html" class="btn">Upgrade Now</a></div>';
                } else {
                    aiTab.innerHTML = `
                        <p style="text-align: center; opacity: 0.8;">Ask me anything (e.g., 'Find marketing managers in tech USA')</p>
                        <input type="text" id="aiInput" placeholder="Type your query..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);" oninput="showSuggestions()">
                        <div id="suggestions" class="suggestions"></div>
                        <button class="btn" onclick="searchAIConversational()">Get AI Leads</button>
                        <div id="aiResults" class="results"></div>
                    `;
                    importsTab.innerHTML = `
                        <p style="text-align: center; opacity: 0.8;">Enter a company name</p>
                        <p style="text-align: center; opacity: 0.8; font-weight: 500;">Import Competitors Supplier Records (e.g., acme imports)</p>
                        <div class="filter-group">
                            <select id="countryFilter">
                                <option value="">All Countries</option>
                                <option value="China">China</option>
                                <option value="Vietnam">Vietnam</option>
                                <option value="USA">USA</option>
                            </select>
                            <select id="yearFilter">
                                <option value="">All Years</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                        <input type="text" id="importsInput" placeholder="Company for import search..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);">
                        <button class="btn" onclick="searchImports()">Find Suppliers</button>
                        <div id="importsResults" class="results"></div>
                        <div id="map"><div class="map-placeholder">Waiting for search results to display competitor suppliers...</div></div>
                    `;
                }
            }
            window.checkAccess = checkAccess;

            function initMap() {
                const mapDiv = document.getElementById('map');
                if (mapDiv && mapDiv.offsetParent !== null) {
                    if (!map) {
                        map = L.map('map').setView([20, 0], 2);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        }).addTo(map);
                        map.getContainer().style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim();
                    }
                }
            }
            window.initMap = initMap;

            function switchTab(tabName, button) {
                const tabs = document.querySelectorAll('.tab-btn');
                const contents = document.querySelectorAll('.tab-content');
                tabs.forEach(btn => btn.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
                if (tabName === 'imports' && (isTestMode || isPremium)) {
                    initMap();
                    if (document.getElementById('importsResults').innerHTML.includes('table')) updateMap();
                }
            }
            window.switchTab = switchTab;

            function searchCompany() {
                const query = document.getElementById('companyInput').value.trim();
                const departmentFilter = document.getElementById('departmentFilter').value;
                const roleFilter = document.getElementById('roleFilter').value;
                const results = document.getElementById('companyResults');
                const errorDiv = document.getElementById('companyError');
                errorDiv.style.display = 'none';

                if (!query.includes('.com') && !query.includes('.org') && !query.includes('.net')) {
                    errorDiv.textContent = 'Incorrect format. Please enter a valid domain (e.g., coca-cola.com).';
                    errorDiv.style.display = 'block';
                    results.innerHTML = '';
                    return;
                }

                results.innerHTML = '<div class="loading">Searching...</div>';
                const mockTotal = (query === 'coca-cola.com') ? 50 : (query === 'monsterenergy.com' ? 15 : 20);
                const mockEmails = {
                    'coca-cola.com': [
                        { name: 'Jane Smith', role: 'Marketing Manager', email: 'jane.smith@coca-cola.com', dept: 'marketing', confidence: 85 },
                        { name: 'Mike Johnson', role: 'Sales Director', email: 'mike.johnson@coca-cola.com', dept: 'sales', confidence: 90 },
                        { name: 'Sarah Lee', role: 'IT Specialist', email: 'sarah.lee@coca-cola.com', dept: 'it', confidence: 75 },
                        { name: 'Tom Brown', role: 'HR Manager', email: 'tom.brown@coca-cola.com', dept: 'hr', confidence: 80 },
                        { name: 'Emily Davis', role: 'Marketing Director', email: 'emily.davis@coca-cola.com', dept: 'marketing', confidence: 88 },
                        { name: 'Alex Carter', role: 'Sales Specialist', email: 'alex.carter@coca-cola.com', dept: 'sales', confidence: 82 },
                        { name: 'Rachel Kim', role: 'IT Director', email: 'rachel.kim@coca-cola.com', dept: 'it', confidence: 87 },
                        { name: 'David Lee', role: 'HR Specialist', email: 'david.lee@coca-cola.com', dept: 'hr', confidence: 78 }
                    ].slice(0, isPremium || isTestMode ? 8 : 2),
                    'monsterenergy.com': [
                        { name: 'John Doe', role: 'Marketing Manager', email: 'john.doe@monsterenergy.com', dept: 'marketing', confidence: 83 },
                        { name: 'Lisa Ray', role: 'Sales Director', email: 'lisa.ray@monsterenergy.com', dept: 'sales', confidence: 89 },
                        { name: 'Mark Hill', role: 'IT Specialist', email: 'mark.hill@monsterenergy.com', dept: 'it', confidence: 76 }
                    ].slice(0, isPremium || isTestMode ? 3 : 2),
                    'default': [
                        { name: 'Test User', role: 'Manager', email: 'test.user@default.com', dept: 'marketing', confidence: 80 }
                    ]
                };

                const emails = mockEmails[query] || mockEmails['default'];
                const filteredEmails = emails.filter(email => 
                    (departmentFilter === 'all' || email.dept === departmentFilter) &&
                    (roleFilter === 'all' || email.role.toLowerCase().includes(roleFilter))
                );
                const emailsByDept = {};
                filteredEmails.forEach(email => {
                    if (!emailsByDept[email.dept]) emailsByDept[email.dept] = [];
                    emailsByDept[email.dept].push(email);
                });

                results.innerHTML = `<p style="color: var(--secondary-text);">Found ${filteredEmails.length} emails across departments (mock data).</p>`;
                for (const [dept, emails] of Object.entries(emailsByDept)) {
                    results.innerHTML += `<div class="department-header">${dept.charAt(0).toUpperCase() + dept.slice(1)} (${emails.length})</div>`;
                    emails.forEach(email => {
                        const maskedEmail = `********@${query.split('.')[0]}.com`;
                        results.innerHTML += `
                            <div class="result-item">
                                <h3>${email.name}</h3>
                                <p class="result-desc">Role: ${email.role}</p>
                                <p class="email">${maskedEmail} <button class="btn" onclick="revealEmail('${email.email}', this, 1)">Reveal (1 Credit)</button> | Confidence: ${email.confidence}%</p>
                            </div>
                        `;
                    });
                }
                if (mockTotal > (isPremium || isTestMode ? 8 : 2) && !isPremium && !isTestMode && (!auth.currentUser || (auth.currentUser && !isPremium))) {
                    results.innerHTML += `<div class="premium-note"><a href="plans.html" class="btn">Upgrade to See All ${mockTotal - (isPremium || isTestMode ? 8 : 2)} Additional Emails</a></div>`;
                } else if (!isPremium && !isTestMode && !auth.currentUser) {
                    results.innerHTML += '<div class="premium-note">Please log in or sign up to reveal emails. <a href="login.html" class="btn btn-inline">Log In</a> <a href="signup.html" class="btn btn-inline">Sign Up</a></div>';
                }
                updateRecentSearches(query);
            }
            window.searchCompany = searchCompany;

            async function loadUserCredits(uid) {
                console.log('Loading credits for UID:', uid);
                const userRef = db.doc('users/' + uid);
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                try {
                    const docSnap = await userRef.get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        console.log('Firestore data for UID', uid, ':', JSON.stringify(data));
                        if (data.isPremium && data.plan === 'enterprise') {
                            userCredits = data.monthlyCredits?.credits || 9999;
                        } else if (data.isPremium) {
                            userCredits = data.monthlyCredits?.credits || 100;
                        } else {
                            userCredits = data.monthlyCredits?.credits || 5;
                        }
                        if (!data.monthlyCredits || data.monthlyCredits.month !== currentMonth) {
                            userCredits = data.isPremium && data.plan === 'enterprise' ? 9999 : data.isPremium ? 250 : 5;
                            await userRef.set({ monthlyCredits: { month: currentMonth, credits: userCredits } }, { merge: true });
                        }
                        if (uid === 'wCw6JFwAUzLh9cSmYVYkcZEUzRv2' && !data.monthlyCredits) {
                            userCredits = 9999;
                            await userRef.set({ monthlyCredits: { month: currentMonth, credits: 9999 } }, { merge: true });
                            console.log('Forced initial 9999 credits for test11 UID');
                        }
                    } else {
                        userCredits = 5;
                        await userRef.set({ isPremium: false, plan: 'free', monthlyCredits: { month: currentMonth, credits: userCredits } });
                        if (uid === 'wCw6JFwAUzLh9cSmYVYkcZEUzRv2') {
                            userCredits = 9999;
                            await userRef.set({ isPremium: true, plan: 'enterprise', monthlyCredits: { month: currentMonth, credits: 9999 } }, { merge: true });
                            console.log('Created Enterprise document with 9999 credits for test11 UID');
                        }
                    }
                } catch (error) {
                    console.error('Error loading credits:', error);
                    userCredits = 5;
                }
                console.log(`Loaded credits for ${uid}: ${userCredits}`);
                if (auth.currentUser) updateDashboardCredits();
                return userCredits;
            }
            window.loadUserCredits = loadUserCredits;

            async function revealEmail(email, button, cost) {
                const user = auth.currentUser;
                if (user) {
                    await loadUserCredits(user.uid);
                    if (userCredits >= cost) {
                        userCredits -= cost;
                        const userRef = db.doc('users/' + user.uid);
                        const now = new Date();
                        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                        await userRef.set({ monthlyCredits: { month: currentMonth, credits: userCredits } }, { merge: true });
                        button.parentElement.innerHTML = email + ` | Credits left: ${userCredits}`;
                        alert(`Email revealed! ${userCredits} credits remaining this month.`);
                        updateDashboardCredits();
                    } else {
                        alert('Not enough credits this month. Upgrade to reveal more emails.');
                        window.location.href = 'plans.html';
                    }
                } else {
                    alert('Please log in to reveal emails.');
                }
            }
            window.revealEmail = revealEmail;

            async function searchAIConversational() {
                const query = document.getElementById('aiInput').value.trim().toLowerCase();
                const results = document.getElementById('aiResults');
                results.innerHTML = '<div class="loading">Thinking...</div>';

                if (!query) {
                    results.innerHTML = '<div class="result-item">Please enter a query.</div>';
                    return;
                }

                try {
                    const keywords = query.match(/\b(\w+\s\w+|\w+)\b/g) || [];
                    let searchTerm = keywords.filter(k => !['in', 'find', 'managers', 'leads'].includes(k.toLowerCase())).join(' ');
                    if (!searchTerm) searchTerm = query;

                    const xPosts = await searchX(searchTerm);
                    const leadCount = xPosts.length;
                    const summary = `AI Summary: Based on your query "${query}", I found ${leadCount} potential leads in ${searchTerm || 'your target area'}. Results are tailored to match your input!`;
                    results.innerHTML = `<p style="color: var(--secondary-text);">AI found ${leadCount} potential leads for: "${query}"</p><p style="color: #90CDF4;">${summary}</p>`;

                    if (leadCount > 0) {
                        xPosts.forEach(post => {
                            const name = post.username || 'Unknown User';
                            results.innerHTML += `
                                <div class="result-item">
                                    <h3>${name}</h3>
                                    <p class="result-desc">${post.text.substring(0, 100)}${post.text.length > 100 ? '...' : ''}</p>
                                    <p><a href="https://x.com/${name}" target="_blank" class="btn">View Profile</a></p>
                                </div>
                            `;
                        });
                    } else {
                        results.innerHTML += '<div class="result-item">No leads found. Try a different query or upgrade for deeper search.</div>';
                    }

                    if (!isPremium && !isTestMode && (!auth.currentUser || (auth.currentUser && !isPremium))) {
                        results.innerHTML += `<div class="premium-note"><a href="plans.html" class="btn">Upgrade for Deeper Insights</a></div>`;
                    } else if (!isPremium && !isTestMode && !auth.currentUser) {
                        results.innerHTML += '<div class="premium-note">Please log in or sign up to access more leads. <a href="login.html" class="btn btn-inline">Log In</a> <a href="signup.html" class="btn btn-inline">Sign Up</a></div>';
                    }
                } catch (error) {
                    console.error('AI search failed:', error);
                    results.innerHTML = '<div class="result-item">Error processing your request. Try again later.</div>';
                }
                updateRecentSearches(query);
            }
            window.searchAIConversational = searchAIConversational;

            async function searchX(searchTerm) {
                try {
                    const basePosts = [
                        { text: "Looking for tech leads? Check @TechLeadPro!", username: "TechLeadPro" },
                        { text: "Marketing managers in USA hiring now @MarketGuru", username: "MarketGuru" },
                        { text: "Tech USA jobs @CodeMaster", username: "CodeMaster" }
                    ];
                    const filteredPosts = basePosts.filter(post => 
                        post.text.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        post.username.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    if (filteredPosts.length === 0 && searchTerm) {
                        filteredPosts.push({
                            text: `Potential lead found for "${searchTerm}" @${searchTerm}Lead`,
                            username: `${searchTerm}Lead`
                        });
                    }
                    return filteredPosts.slice(0, 5);
                } catch (error) {
                    console.error('X search mock failed:', error);
                    return [];
                }
            }

            function searchAI() {
                searchAIConversational();
            }
            window.searchAI = searchAI;

            function showSuggestions() {
                const input = document.getElementById('aiInput').value.toLowerCase();
                const suggestions = document.getElementById('suggestions');
                if (!input) {
                    suggestions.innerHTML = '';
                    return;
                }
                const suggestionTemplates = [
                    `Find ${input} managers in tech USA`,
                    `Find ${input} directors in finance`,
                    `Find ${input} specialists in healthcare`
                ].filter(s => s.includes(input));
                suggestions.innerHTML = suggestionTemplates.map(s => `<div style="cursor: pointer;" onclick="document.getElementById('aiInput').value='${s}';suggestions.innerHTML='';searchAIConversational();">${s}</div>`).join('<br>');
            }
            window.showSuggestions = showSuggestions;

            let sortDirection = 1;
            let currentPage = 1;
            const itemsPerPage = 3;

            function sortTable(columnIndex) {
                const table = document.querySelector('#importsResults table');
                if (table) {
                    const rows = Array.from(table.querySelectorAll('tr')).slice(1);
                    rows.sort((a, b) => {
                        const aValue = a.cells[columnIndex].textContent;
                        const bValue = b.cells[columnIndex].textContent;
                        return aValue.localeCompare(bValue, undefined, { numeric: true }) * sortDirection;
                    });
                    rows.forEach(row => table.appendChild(row));
                    sortDirection *= -1;
                    updatePagination();
                    updateMap();
                }
            }
            window.sortTable = sortTable;

            function updatePagination() {
                const table = document.querySelector('#importsResults table');
                if (table) {
                    const rows = Array.from(table.querySelectorAll('tr')).slice(1);
                    const totalPages = Math.ceil(rows.length / itemsPerPage);
                    const pagination = document.querySelector('.pagination');
                    if (pagination) {
                        pagination.innerHTML = '';
                        for (let i = 1; i <= totalPages; i++) {
                            const button = document.createElement('button');
                            button.textContent = i;
                            button.addEventListener('click', () => {
                                currentPage = i;
                                displayPage();
                            });
                            if (i === currentPage) button.classList.add('active');
                            pagination.appendChild(button);
                        }
                        displayPage();
                    }
                }
            }
            window.updatePagination = updatePagination;

            function displayPage() {
                const table = document.querySelector('#importsResults table');
                if (table) {
                    const rows = Array.from(table.querySelectorAll('tr')).slice(1);
                    const start = (currentPage - 1) * itemsPerPage;
                    const end = start + itemsPerPage;
                    rows.forEach((row, index) => {
                        row.style.display = (index >= start && index < end) ? '' : 'none';
                    });
                    updateMap();
                }
            }
            window.displayPage = displayPage;

            function updateMap() {
                if (!map) initMap();
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.CircleMarker) map.removeLayer(layer);
                });
                const table = document.querySelector('#importsResults table');
                if (table) {
                    const rows = Array.from(table.querySelectorAll('tr')).slice(1).filter(row => row.style.display !== 'none');
                    if (rows.length > 0) {
                        rows.forEach(row => {
                            const country = row.cells[1].textContent.trim();
                            const tradeValue = parseFloat(row.cells[2].textContent.replace('$', '').replace(',', '')) || 1000;
                            const supplier = row.cells[0].textContent.trim();
                            const coords = getCountryCoords(country);
                            if (coords[0] !== 0 || coords[1] !== 0) {
                                const radius = Math.min(20, tradeValue / 1000) || 5;
                                L.circleMarker(coords, {
                                    color: var(--accent-color),
                                    fillColor: var(--accent-color),
                                    fillOpacity: 0.5,
                                    radius: radius
                                }).addTo(map).bindTooltip(`<b>${supplier}</b><br>Trade Value: $${tradeValue.toLocaleString()}<br>Country: ${country}`, {
                                    permanent: false,
                                    direction: 'top',
                                    className: 'map-tooltip'
                                }).on('click', () => {
                                    alert(`Supplier: ${supplier}\nTrade Value: $${tradeValue.toLocaleString()}\nCountry: ${country}`);
                                });
                            }
                        });
                        map.fitBounds(rows.map(row => getCountryCoords(row.cells[1].textContent.trim())).filter(coord => coord[0] !== 0 || coord[1] !== 0));
                    }
                }
            }
            window.updateMap = updateMap;

            function getCountryCoords(country) {
                const coords = {
                    'China': [35.8617, 104.1954],
                    'Vietnam': [14.0583, 108.2772],
                    'Mexico': [23.6345, -102.5528],
                    'Brazil': [-14.2350, -51.9253],
                    'Thailand': [15.8700, 100.9925],
                    'India': [20.5937, 78.9629],
                    'USA': [37.0902, -95.7129],
                    'default': [0, 0]
                };
                return coords[country] || coords['default'];
            }
            window.getCountryCoords = getCountryCoords;

            function searchImports() {
                const query = document.getElementById('importsInput').value.toLowerCase().trim().replace('ing', '');
                const countryFilter = document.getElementById('countryFilter').value;
                const yearFilter = document.getElementById('yearFilter').value;
                const results = document.getElementById('importsResults');
                results.innerHTML = '<div class="loading">Searching...</div>';

                if (!query) {
                    results.innerHTML = '<div class="result-item">Enter a company name.</div>';
                    return;
                }

                const mockSuppliers = {
                    'acme imports': [
                        { supplier: 'Global Supply Co.', country: 'China', tradeValue: '$5000', year: '2023', product: 'Machinery Parts' },
                        { supplier: 'East Trade Ltd.', country: 'Vietnam', tradeValue: '$3000', year: '2022', product: 'Machinery Parts' }
                    ],
                    'coca-cola': [
                        { supplier: 'Beverage Logistics Inc.', country: 'Mexico', tradeValue: '$10000', year: '2023', product: 'Soft Drinks' },
                        { supplier: 'Sweet Water Suppliers', country: 'Brazil', tradeValue: '$7500', year: '2022', product: 'Soft Drinks' }
                    ],
                    'monsterenergy': [
                        { supplier: 'Energy Pack Ltd.', country: 'Thailand', tradeValue: '$4000', year: '2023', product: 'Energy Drinks' }
                    ],
                    'default': [
                        { supplier: 'Sample Supplier', country: 'USA', tradeValue: '$1000', year: '2023', product: 'Miscellaneous' }
                    ]
                };

                const suppliers = mockSuppliers[query] || mockSuppliers['default'];
                let tableHTML = `
                    <div class="summary-box">Trade Insights for ${query.toUpperCase()} | Last Updated: ${new Date().toLocaleDateString()} ${isPremium || isTestMode ? '' : '| <a href="plans.html" class="btn">Upgrade for Full Report</a>'}</div>
                    <table class="result-table">
                        <tr>
                            <th onclick="sortTable(0)">Supplier</th>
                            <th onclick="sortTable(1)">Country</th>
                            <th onclick="sortTable(2)">Trade Value</th>
                            <th onclick="sortTable(3)">Year</th>
                            <th onclick="sortTable(4)">Product</th>
                            <th>Action</th>
                        </tr>
                `;
                const filteredSuppliers = suppliers.filter(supplier => {
                    const matchesCountry = !countryFilter || supplier.country === countryFilter;
                    const matchesYear = !yearFilter || supplier.year === yearFilter;
                    return matchesCountry && matchesYear;
                });

                if (filteredSuppliers.length > 0 && (isTestMode || isPremium)) {
                    filteredSuppliers.slice(0, 3).forEach(supplier => {
                        tableHTML += `
                            <tr>
                                <td>${supplier.supplier}</td>
                                <td>${supplier.country}</td>
                                <td>${supplier.tradeValue}</td>
                                <td>${supplier.year}</td>
                                <td>${supplier.product}</td>
                                <td><button class="btn premium" onclick="viewReport()">View Report (Premium)</button></td>
                            </tr>
                        `;
                    });
                    tableHTML += `<p style="color: var(--secondary-text); text-align: center;">Showing ${Math.min(3, filteredSuppliers.length)} of ${suppliers.length} results</p>`;
                    if (suppliers.length > 3 && !isPremium && !isTestMode) {
                        tableHTML += `<div class="premium-note">Upgrade to see all ${suppliers.length} results</div><div class="pagination"></div>`;
                    }
                } else {
                    tableHTML += '<tr><td colspan="6">No supplier records found with current filters.</td></tr>';
                }
                tableHTML += '</table>';
                results.innerHTML = tableHTML;
                updatePagination();
                updateMap();
            }
            window.searchImports = searchImports;

            function viewReport() {
                if (!isPremium && !isTestMode) {
                    alert('This feature requires a Business/Enterprise plan. Upgrade to access full reports.');
                    window.location.href = 'plans.html';
                } else {
                    alert('Full report: Detailed supplier analysis, trade history, and contact info available. Visit plans.html for more!');
                }
            }
            window.viewReport = viewReport;

            function updateRecentSearches(query) {
                let recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
                if (!recent.includes(query)) {
                    recent.unshift(query);
                    if (recent.length > 5) recent.pop();
                    localStorage.setItem('recentSearches', JSON.stringify(recent));
                }
                if (auth.currentUser) updateDashboardCredits();
            }

            function startTour() {
                let step = 1;
                const steps = [
                    "Welcome to NovaHunt! This tour will showcase premium features.",
                    "Use 'Hunt Corporate Emails' to find emails (e.g., coca-cola.com).",
                    "Try 'Hunt Industry Leads' with AI queries (e.g., 'Find marketing managers in tech USA'). AI suggests queries as you type!",
                    "Explore 'Hunt Import Records' for supplier data with the map (e.g., acme imports).",
                    "Toggle 'Test Mode' to simulate premium access. Sign up for the full experience!",
                    "Switch themes with the toggle above. End of tour! Visit plans.html to upgrade."
                ];
                alert(steps[step - 1]);
                const interval = setInterval(() => {
                    if (step < steps.length) {
                        step++;
                        alert(steps[step - 1]);
                    } else {
                        clearInterval(interval);
                    }
                }, 3000);
            }
            window.startTour = startTour;

            function toggleTheme() {
                console.log('Toggling theme at v25:', new Date().toLocaleTimeString());
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', newTheme);
                const label = document.getElementById('themeSwitch').nextElementSibling;
                label.textContent = `Switch to ${newTheme === 'light' ? 'Dark' : 'Light'} Theme`;
                if (map) {
                    map.getContainer().style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim();
                }
            }
            window.toggleTheme = toggleTheme;
        });
    </script>
</body>
</html>