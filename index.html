<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaHunt - AI Lead Hunter</title>
    <meta name="description" content="NovaHunt.ai: AI-powered tool to hunt B2B leads, emails, and suppliers with precision.">
    <meta name="keywords" content="AI lead generation, B2B leads, email hunter, supplier finder">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¥·</text></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=1.1.2" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1A202C; color: #E2E8F0; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .section { padding: 60px 0; }
        h1 { font-size: 2.8em; font-weight: 800; text-align: center; color: #00FFCC; margin-bottom: 15px; text-shadow: 0 0 10px #00FFCC; }
        h2 { font-size: 2em; font-weight: 700; color: #E2E8F0; margin-bottom: 20px; text-align: center; }
        p { font-size: 1.1em; color: #A0AEC0; margin-bottom: 20px; text-align: center; }
        .btn { background: #00FFCC; color: #1A202C; padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; text-decoration: none; display: inline-block; }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 15px #00FFCC; }
        .btn-primary { background: #00FFCC; color: #1A202C; font-size: 1em; padding: 10px 20px; border-radius: 6px; }
        .btn-inline { padding: 4px 8px; font-size: 0.8em; margin: 0 5px; }
        .search-tabs { display: flex; background: #2D3748; border-radius: 6px; overflow: hidden; margin-bottom: 20px; justify-content: center; }
        .tab-btn { flex: 1; padding: 12px; background: transparent; color: #E2E8F0; border: none; cursor: pointer; font-size: 1em; transition: background 0.3s; }
        .tab-btn.active { background: #00FFCC; color: #1A202C; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .results { margin-top: 20px; }
        .result-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .result-table th, .result-table td { padding: 10px; text-align: left; border-bottom: 1px solid #4A5568; word-wrap: break-word; }
        .result-table th { background: #2D3748; font-weight: 600; color: #E2E8F0; cursor: pointer; }
        .result-table th:hover { background: #4A5568; }
        .result-table td { background: #2D3748; }
        .result-table .premium { color: #1A202C; font-style: italic; background: #00FFCC; padding: 5px 10px; border-radius: 4px; text-align: center; }
        .loading { color: #90CDF4; font-style: italic; text-align: center; }
        .summary-box { background: #2D3748; border: 1px solid #4A5568; border-radius: 6px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 10px #00FFCC; }
        .pagination { text-align: center; margin-top: 10px; }
        .pagination button { background: #4A5568; color: #E2E8F0; border: 1px solid #718096; border-radius: 4px; padding: 5px 10px; margin: 0 5px; cursor: pointer; }
        .pagination button:hover { background: #718096; }
        .pagination button.active { background: #00FFCC; color: #1A202C; }
        .department-header { font-size: 1.2em; font-weight: 600; color: #E2E8F0; margin: 10px 0 5px; }
        .premium-note { font-size: 0.8em; color: #90CDF4; margin-top: 10px; text-align: center; padding-bottom: 20px; }
        .error { color: #FC8181; font-size: 1em; margin-top: 10px; text-align: center; font-weight: bold; padding: 10px; background: #2D3748; border-radius: 4px; }
        .filter-group { margin-bottom: 10px; display: flex; gap: 10px; justify-content: center; }
        .filter-group select { padding: 8px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0; }
        .toggle-group { display: none; }
        #map { height: 400px; width: 100%; margin-top: 40px; border: 2px solid #00FFCC; border-radius: 6px; position: relative; }
        .map-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #A0AEC0; font-style: italic; }
        .plans-section { padding: 40px 0; }
        .plan-card { background: #2D3748; border: 1px solid #4A5568; border-radius: 8px; padding: 20px; margin: 15px; text-align: center; max-width: 250px; display: inline-block; vertical-align: top; box-shadow: 0 0 10px #00FFCC; }
        .plan-card h3 { color: #00FFCC; margin-bottom: 10px; }
        .plan-card ul { list-style: none; padding: 0; }
        .plan-card ul li { margin: 10px 0; color: #A0AEC0; }
        .plan-card .price { font-size: 1.5em; color: #E2E8F0; margin: 10px 0; }
        .plan-card .btn { margin-top: 15px; }
        .back-button { text-align: center; margin: 20px 0; }
        .upgrade-message { color: #FC8181; text-align: center; margin-top: 20px; font-weight: bold; }
        .badge { background: #FFCC00; color: #1A202C; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .test-mode-toggle { text-align: center; margin: 10px 0; }
        .test-mode-toggle input { margin-right: 5px; }
        .nav { position: fixed; top: 20px; right: 20px; z-index: 1000; } /* Ensured fixed */
        .nav .user-info, .nav button { display: inline-block; margin-right: 10px; }
        .tour-btn { position: fixed; bottom: 20px; right: 20px; background: #00FFCC; color: #1A202C; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .tour-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px #00FFCC; }
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            .search-tabs { flex-direction: column; }
            .result-table { display: block; overflow-x: auto; }
            #map { height: 250px; margin-top: 30px; }
            .plan-card { max-width: 100%; margin: 10px 0; }
            .filter-group { flex-direction: column; }
            .tour-btn { bottom: 10px; right: 10px; }
            .nav { top: 10px; right: 10px; }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <section class="section" style="padding-top: 80px; background: #1A202C; box-shadow: 0 4px 20px rgba(0, 255, 204, 0.3);">
        <div class="container">
            <h1>ðŸ¥· NovaHunt</h1>
            <p style="font-size: 1.2em;">AI-Powered Lead Generation That Hunts for You</p>
            <p>Redefine B2B success with cutting-edge AI precision.</p>
            <div style="text-align: center; margin-top: 20px;"><a href="plans.html" class="btn">Get Started</a></div>
            <p style="font-size: 0.9em; color: #90CDF4;">free credits â€¢ No credit card required</p>
            <div class="test-mode-toggle">
                <input type="checkbox" id="testMode" onchange="toggleTestMode()">
                <label for="testMode">Enable Test Mode (Business/Enterprise Access)</label>
            </div>
        </div>
    </section>

    <!-- Navigation (Auth) -->
    <div class="nav" id="navLinks"></div>

    <!-- Multi-Mode Search Section -->
    <section class="section">
        <div class="container">
            <h2>Search for Leads</h2>
            <p>Unleash NovaHuntâ€™s power across multiple modes.</p>
            <div class="search-tabs">
                <button class="tab-btn active" onclick="switchTab('company', this)">Hunt Corporate Emails</button>
                <button class="tab-btn" onclick="switchTab('ai', this)">Hunt Industry Leads</button>
                <button class="tab-btn" onclick="switchTab('imports', this)">Hunt Import Records</button>
            </div>
            <div id="company-tab" class="tab-content active">
                <p style="text-align: center; opacity: 0.8;">Enter a company name or domain (e.g., coca-cola.com).</p>
                <input type="text" id="companyInput" placeholder="Company or domain..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0;">
                <div id="companyError" class="error" style="display: none;"></div>
                <button class="btn-primary" onclick="searchCompany()">Find Emails & Contacts</button>
                <div id="companyResults" class="results"></div>
            </div>
            <div id="ai-tab" class="tab-content">
                <div class="upgrade-message">This feature is for Business/Enterprise users. <a href="plans.html" class="btn">Upgrade Now</a></div>
            </div>
            <div id="imports-tab" class="tab-content">
                <p style="text-align: center; opacity: 0.8;">Enter a company name</p>
                <p style="text-align: center; opacity: 0.8; font-weight: 500;">Import Competitors Supplier Records (e.g., acme imports)</p>
                <div class="filter-group">
                    <select id="countryFilter">
                        <option value="">All Countries</option>
                        <option value="China">China</option>
                        <option value="Vietnam">Vietnam</option>
                        <option value="USA">USA</option>
                    </select>
                    <select id="yearFilter">
                        <option value="">All Years</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
                <input type="text" id="importsInput" placeholder="Company for import search..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0;">
                <button class="btn" onclick="searchImports()">Find Suppliers</button>
                <div id="importsResults" class="results"></div>
                <div id="map"><div class="map-placeholder">Waiting for search results to display competitor suppliers...</div></div>
            </div>
        </div>
    </section>

    <!-- Tour Button -->
    <button class="tour-btn" onclick="startTour()">Take a Tour</button>

    <!-- Footer -->
    <footer style="text-align: center; padding: 20px 0; color: #A0AEC0; font-size: 0.9em;">
        Â© 2025 NovaHunt.ai | All rights reserved | <a href="terms.html" style="color: #90CDF4; text-decoration: none;">Terms of Service</a> | <a href="privacy.html" style="color: #90CDF4; text-decoration: none;">Privacy Policy</a> | <a href="faq.html" style="color: #90CDF4; text-decoration: none;">FAQ</a>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=1.1.2"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyArKU9HQx7An_PhRM2jlzIHVnLp1EmISlA",
            authDomain: "novahunt-web-app-v2.firebaseapp.com",
            projectId: "novahunt-web-app-v2",
            storageBucket: "novahunt-web-app-v2.firebasestorage.app",
            messagingSenderId: "915754711081",
            appId: "1:915754711081:web:f563cc734c901812954438"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize global variables
        let userCredits = 5; // Default monthly credits for free users
        let isPremium = false;
        let isTestMode = false;
        let map;

        // Redirect to login if not authenticated
        auth.onAuthStateChanged((user) => {
            if (!user) {
                updateUI(null);
                checkAccess();
            } else {
                updateUI(user);
                loadUserCredits(user.uid).then(() => checkAccess());
            }
        });

        // Update UI based on auth state
        function updateUI(user) {
            const navLinks = document.getElementById('navLinks');
            if (user) {
                navLinks.innerHTML = `<div class="user-info">Logged in as: ${user.email}</div><button class="btn" onclick="logout()">Logout</button>`;
            } else {
                navLinks.innerHTML = `<a href="login.html" class="btn">Sign In</a> <a href="signup.html" class="btn">Sign Up</a>`;
            }
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                updateUI(null);
                alert('Logged out successfully!');
                window.location.href = 'login.html';
            }).catch((error) => {
                alert('Error logging out: ' + error.message);
            });
        }
        window.logout = logout;

        // Toggle test mode
        function toggleTestMode() {
            isTestMode = !isTestMode;
            alert(`Test mode ${isTestMode ? 'enabled' : 'disabled'}. Premium features ${isTestMode ? 'available' : 'restricted'}.`);
            checkAccess();
        }
        window.toggleTestMode = toggleTestMode;

        // Check access for premium sections
        function checkAccess() {
            const aiTab = document.getElementById('ai-tab');
            const importsTab = document.getElementById('imports-tab');
            const user = auth.currentUser;
            if (!isTestMode && !user && !isPremium) {
                aiTab.innerHTML = '<div class="upgrade-message">This feature is for Business/Enterprise users. <a href="plans.html" class="btn">Upgrade Now</a></div>';
                importsTab.innerHTML = '<div class="upgrade-message">This feature is for Business/Enterprise users. <a href="plans.html" class="btn">Upgrade Now</a></div>';
            } else if (!isTestMode && user && !isPremium) {
                aiTab.innerHTML = '<div class="upgrade-message">This feature requires a Business/Enterprise plan. <a href="plans.html" class="btn">Upgrade Now</a></div>';
                importsTab.innerHTML = '<div class="upgrade-message">This feature requires a Business/Enterprise plan. <a href="plans.html" class="btn">Upgrade Now</a></div>';
            } else {
                aiTab.innerHTML = '<p style="text-align: center; opacity: 0.8;">Enter a query like \'Ice Cream Companies USA\' for live results.</p><input type="text" id="aiInput" placeholder="AI-powered lead query..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0;"><button class="btn" onclick="searchAI()">Generate Leads</button><div id="aiResults" class="results"></div>';
                importsTab.innerHTML = '<p style="text-align: center; opacity: 0.8;">Enter a company name</p><p style="text-align: center; opacity: 0.8; font-weight: 500;">Import Competitors Supplier Records (e.g., acme imports)</p><div class="filter-group"><select id="countryFilter"><option value="">All Countries</option><option value="China">China</option><option value="Vietnam">Vietnam</option><option value="USA">USA</option></select><select id="yearFilter"><option value="">All Years</option><option value="2023">2023</option><option value="2022">2022</option></select></div><input type="text" id="importsInput" placeholder="Company for import search..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0;"><button class="btn" onclick="searchImports()">Find Suppliers</button><div id="importsResults" class="results"></div><div id="map"><div class="map-placeholder">Waiting for search results to display competitor suppliers...</div></div>';
            }
        }
        window.checkAccess = checkAccess;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            updateUI(auth.currentUser);
            checkAccess();
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('onclick').match(/switchTab\('([^']+)'.*/)[1];
                    switchTab(tabName, e.target);
                });
            });
        });

        // Initialize map
        function initMap() {
            const mapDiv = document.getElementById('map');
            if (mapDiv && mapDiv.offsetParent !== null) {
                if (!map) {
                    map = L.map('map').setView([20, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(map);
                    map.getContainer().style.background = '#1A202C';
                }
            }
        }
        window.initMap = initMap;

        // Tab switching with map refresh
        function switchTab(tabName, button) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(btn => btn.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            if (tabName === 'imports') {
                initMap();
                if (document.getElementById('importsResults').innerHTML.includes('table')) updateMap();
            }
            console.log(`Switched to ${tabName} tab`);
        }
        window.switchTab = switchTab;

        // Company Search with Hunter.io API via AllOrigins Proxy
        function searchCompany() {
            const query = document.getElementById('companyInput').value.trim();
            const results = document.getElementById('companyResults');
            const errorDiv = document.getElementById('companyError');
            errorDiv.style.display = 'none';

            if (!query.includes('.com') && !query.includes('.org') && !query.includes('.net')) {
                errorDiv.textContent = 'Incorrect format. Please enter a valid domain (e.g., coca-cola.com).';
                errorDiv.style.display = 'block';
                results.innerHTML = '';
                return;
            }

            results.innerHTML = '<div class="loading">Searching...</div>';
            const apiKey = 'b2eb114113547c1eeb296f358fb10653acc0727a';
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://api.hunter.io/v2/domain-search?domain=${encodeURIComponent(query)}&api_key=${apiKey}`;
            fetch(proxyUrl + encodeURIComponent(apiUrl))
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.errors) throw new Error(data.data.errors[0].message);
                    const mockTotal = (query === 'coca-cola.com') ? 444 : (query === 'monsterenergy.com' ? 45 : data.data.emails.length);
                    results.innerHTML = `<p style="color: #A0AEC0;">Found ${mockTotal} emails across departments.</p>`;

                    const emailsByDept = {};
                    data.data.emails.slice(0, 10).forEach(email => {
                        const dept = email.department || 'Unknown';
                        if (!emailsByDept[dept]) emailsByDept[dept] = [];
                        emailsByDept[dept].push(email);
                    });

                    for (const [dept, emails] of Object.entries(emailsByDept)) {
                        results.innerHTML += `<div class="department-header">${dept} (${emails.length})</div>`;
                        emails.slice(0, 10).forEach(email => {
                            const name = email.first_name || email.last_name ? `${email.first_name || ''} ${email.last_name || ''}`.trim() : 'N/A';
                            const role = email.position || 'N/A';
                            const confidence = email.confidence || 'N/A';
                            const maskedEmail = `********@${query.split('.')[0]}.com`;
                            results.innerHTML += `
                                <div class="result-item">
                                    <h3>${name}</h3>
                                    <p class="result-desc">Role: ${role}</p>
                                    <p class="email">${maskedEmail} <button class="btn" onclick="revealEmail('${email.value}', this, 1)">Reveal (1 Credit)</button> | Confidence: ${confidence}%</p>
                                </div>
                            `;
                        });
                    }
                    if (!isPremium && !isTestMode && !auth.currentUser) {
                        results.innerHTML += '<div class="premium-note">Please log in or sign up to reveal emails and unlock more features. <a href="login.html" class="btn btn-inline">Log In</a> <a href="signup.html" class="btn btn-inline">Sign Up</a></div>';
                    } else if (!isPremium && !isTestMode) {
                        results.innerHTML += `<div class="premium-note"><a href="plans.html" class="btn">Upgrade to See All ${mockTotal - 10} Additional Emails</a></div>`;
                    }
                })
                .catch(err => {
                    console.error('API fetch failed:', err);
                    results.innerHTML = `<div class="result-item">API Error: ${err.message}. Showing mock data for ${query}...</div>`;
                    const mockTotal = (query === 'coca-cola.com') ? 444 : (query === 'monsterenergy.com' ? 45 : 10);
                    results.innerHTML += `<p style="color: #A0AEC0;">Mock data: Found ${mockTotal} emails across departments.</p>`;
                    const mockEmails = [
                        { name: 'Jane Smith', role: 'Marketing Manager', email: 'jane.smith@' + query.split('.')[0] + '.com', dept: 'Marketing', confidence: 80 },
                        { name: 'Mike Johnson', role: 'Sales Director', email: 'mike.johnson@' + query.split('.')[0] + '.com', dept: 'Sales', confidence: 85 },
                        { name: 'Sarah Lee', role: 'HR Specialist', email: 'sarah.lee@' + query.split('.')[0] + '.com', dept: 'Human Resources', confidence: 70 },
                        { name: 'Tom Brown', role: 'IT Lead', email: 'tom.brown@' + query.split('.')[0] + '.com', dept: 'IT', confidence: 75 },
                        { name: 'Emily Davis', role: 'Finance Analyst', email: 'emily.davis@' + query.split('.')[0] + '.com', dept: 'Finance', confidence: 78 },
                        { name: 'David Wilson', role: 'Product Manager', email: 'david.wilson@' + query.split('.')[0] + '.com', dept: 'Product', confidence: 82 },
                        { name: 'Lisa Anderson', role: 'Operations Lead', email: 'lisa.anderson@' + query.split('.')[0] + '.com', dept: 'Operations', confidence: 77 },
                        { name: 'Robert Taylor', role: 'Marketing Assistant', email: 'robert.taylor@' + query.split('.')[0] + '.com', dept: 'Marketing', confidence: 73 },
                        { name: 'Karen White', role: 'Sales Rep', email: 'karen.white@' + query.split('.')[0] + '.com', dept: 'Sales', confidence: 76 },
                        { name: 'John Doe', role: 'CEO', email: 'john.doe@' + query.split('.')[0] + '.com', dept: 'Executive', confidence: 75 }
                    ];
                    const mockEmailsByDept = {};
                    mockEmails.forEach(email => {
                        if (!mockEmailsByDept[email.dept]) mockEmailsByDept[email.dept] = [];
                        mockEmailsByDept[email.dept].push(email);
                    });
                    for (const [dept, emails] of Object.entries(mockEmailsByDept)) {
                        results.innerHTML += `<div class="department-header">${dept} (${emails.length})</div>`;
                        emails.slice(0, 10).forEach(email => {
                            const maskedEmail = `********@${query.split('.')[0]}.com`;
                            results.innerHTML += `
                                <div class="result-item">
                                    <h3>${email.name}</h3>
                                    <p class="result-desc">Role: ${email.role}</p>
                                    <p class="email">${maskedEmail} <button class="btn" onclick="revealEmail('${email.email}', this, 1)">Reveal (1 Credit)</button> | Confidence: ${email.confidence}%</p>
                                </div>
                            `;
                        });
                    }
                    if (!isPremium && !isTestMode && !auth.currentUser) {
                        results.innerHTML += '<div class="premium-note">Please log in or sign up to reveal emails and unlock more features. <a href="login.html" class="btn btn-inline">Log In</a> <a href="signup.html" class="btn btn-inline">Sign Up</a></div>';
                    } else if (!isPremium && !isTestMode) {
                        results.innerHTML += `<div class="premium-note"><a href="plans.html" class="btn">Upgrade to See All ${mockTotal - 10} Additional Emails</a></div>`;
                    }
                });
        }
        window.searchCompany = searchCompany;

        // Load user credits from Firestore (async to ensure latest data)
        async function loadUserCredits(uid) {
            const userRef = doc(db, 'users', uid);
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.monthlyCredits && data.monthlyCredits.month === currentMonth) {
                        userCredits = data.monthlyCredits.credits;
                    } else {
                        userCredits = 5;
                        await setDoc(userRef, {
                            monthlyCredits: { month: currentMonth, credits: userCredits }
                        }, { merge: true });
                    }
                } else {
                    userCredits = 5;
                    await setDoc(userRef, {
                        monthlyCredits: { month: currentMonth, credits: userCredits }
                    });
                }
            } catch (error) {
                console.error('Error loading credits:', error);
                userCredits = 5;
            }
            return userCredits;
        }
        window.loadUserCredits = loadUserCredits;

        // Reveal email function with monthly tracking per user
        async function revealEmail(email, button, cost) {
            const user = auth.currentUser;
            if (user) {
                await loadUserCredits(user.uid); // Reload credits before checking
                if (userCredits >= cost) {
                    userCredits -= cost;
                    button.parentElement.innerHTML = email + ` | Credits left: ${userCredits}`;
                    alert(`Email revealed! ${userCredits} credits remaining this month.`);

                    const userRef = doc(db, 'users', user.uid);
                    const now = new Date();
                    const currentMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
                    await setDoc(userRef, {
                        monthlyCredits: { month: currentMonth, credits: userCredits }
                    }, { merge: true });
                } else {
                    alert('Not enough credits this month. Upgrade to reveal more emails.');
                    window.location.href = 'plans.html';
                }
            } else {
                alert('Please log in or sign up to reveal emails and unlock more features.');
            }
        }
        window.revealEmail = revealEmail;

        // AI Industry Search with OpenCorporates and DuckDuckGo Fallback
        function searchAI() {
            const query = document.getElementById('aiInput').value.trim().toLowerCase().replace('stores', 'companies');
            const results = document.getElementById('aiResults');
            results.innerHTML = '<div class="loading">Searching...</div>';
            if (!query) {
                results.innerHTML = '<div class="result-item">Enter a query.</div>';
                return;
            }
            const ocApiUrl = `https://api.opencorporates.com/v0.4/companies/search?q=${encodeURIComponent(query)}&per_page=5`;
            fetch(ocApiUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`OpenCorporates error! Status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    results.innerHTML = '';
                    if (!data.results || data.results.companies.length === 0) throw new Error('No companies from OpenCorporates');
                    data.results.companies.slice(0, 2).forEach(company => {
                        const name = company.company.name || 'N/A';
                        const url = company.company.company_number ? `https://opencorporates.com/companies/${company.company.jurisdiction_code}/${company.company.company_number}` : '#';
                        results.innerHTML += `<div class="result-item"><h3>${name}</h3><a href="${url}" target="_blank" class="btn">View Profile</a></div>`;
                    });
                    if (!isPremium && !isTestMode) {
                        results.innerHTML += `<div class="premium-note"><a href="plans.html" class="btn">Upgrade to See All ${data.results.companies.length - 2} Additional Companies</a></div>`;
                    }
                })
                .catch(err => {
                    console.error('OpenCorporates failed, falling back to DuckDuckGo:', err);
                    const ddApiUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent('list of ' + query + ' site:*.com -inurl:(signup | login)')}&format=json`;
                    fetch(ddApiUrl)
                        .then(response => {
                            if (!response.ok) throw new Error(`DuckDuckGo error! Status: ${response.status}`);
                            return response.json();
                        })
                        .then(data => {
                            results.innerHTML = '';
                            if (!data.RelatedTopics || data.RelatedTopics.length === 0) {
                                results.innerHTML = '<div class="result-item">No companies found. Showing mock data for ' + query + '...</div>';
                                const mockCompanies = [
                                    { name: 'Ice Cream Co. USA', url: 'https://example.com/icecreamusa' },
                                    { name: 'Frosty Treats Inc.', url: 'https://example.com/frostytreats' }
                                ];
                                mockCompanies.forEach(company => {
                                    results.innerHTML += `<div class="result-item"><h3>${company.name}</h3><a href="${company.url}" target="_blank" class="btn">View Profile</a></div>`;
                                });
                                if (!isPremium && !isTestMode) {
                                    results.innerHTML += '<div class="premium-note"><a href="plans.html" class="btn">Upgrade to See All 142 Additional Companies</a></div>';
                                }
                            } else {
                                data.RelatedTopics.slice(0, 2).forEach(topic => {
                                    const name = topic.Text || 'N/A';
                                    const url = topic.FirstURL || '#';
                                    results.innerHTML += `<div class="result-item"><h3>${name}</h3><a href="${url}" target="_blank" class="btn">View Profile</a></div>`;
                                });
                                if (!isPremium && !isTestMode) {
                                    results.innerHTML += `<div class="premium-note"><a href="plans.html" class="btn">Upgrade to See All ${data.RelatedTopics.length - 2} Additional Companies</a></div>`;
                                }
                            }
                        })
                        .catch(ddErr => {
                            results.innerHTML = '<div class="result-item">Error: Both APIs failed. Showing mock data for ' + query + '...</div>';
                            const mockCompanies = [
                                { name: 'Ice Cream Co. USA', url: 'https://example.com/icecreamusa' },
                                { name: 'Frosty Treats Inc.', url: 'https://example.com/frostytreats' }
                            ];
                            mockCompanies.forEach(company => {
                                results.innerHTML += `<div class="result-item"><h3>${company.name}</h3><a href="${company.url}" target="_blank" class="btn">View Profile</a></div>`;
                            });
                            if (!isPremium && !isTestMode) {
                                results.innerHTML += '<div class="premium-note"><a href="plans.html" class="btn">Upgrade to See All 142 Additional Companies</a></div>';
                            }
                            console.error('DuckDuckGo fallback failed:', ddErr);
                        });
                });
        }
        window.searchAI = searchAI;

        // Import Records Search
        let sortDirection = 1;
        let currentPage = 1;
        const itemsPerPage = 3;

        function sortTable(columnIndex) {
            const table = document.querySelector('#importsResults table');
            const rows = Array.from(table.querySelectorAll('tr')).slice(1);
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent;
                const bValue = b.cells[columnIndex].textContent;
                return aValue.localeCompare(bValue, undefined, { numeric: true }) * sortDirection;
            });
            rows.forEach(row => table.appendChild(row));
            sortDirection *= -1;
            updatePagination();
            updateMap();
        }
        window.sortTable = sortTable;

        function updatePagination() {
            const table = document.querySelector('#importsResults table');
            const rows = Array.from(table.querySelectorAll('tr')).slice(1);
            const totalPages = Math.ceil(rows.length / itemsPerPage);
            const pagination = document.querySelector('.pagination');
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.addEventListener('click', () => {
                    currentPage = i;
                    displayPage();
                });
                if (i === currentPage) button.classList.add('active');
                pagination.appendChild(button);
            }
            displayPage();
        }
        window.updatePagination = updatePagination;

        function displayPage() {
            const table = document.querySelector('#importsResults table');
            const rows = Array.from(table.querySelectorAll('tr')).slice(1);
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            rows.forEach((row, index) => {
                row.style.display = (index >= start && index < end) ? '' : 'none';
            });
            updateMap();
        }
        window.displayPage = displayPage;

        function updateMap() {
            if (!map) initMap();
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.CircleMarker) map.removeLayer(layer);
            });
            const table = document.querySelector('#importsResults table');
            if (table) {
                const rows = Array.from(table.querySelectorAll('tr')).slice(1).filter(row => row.style.display !== 'none');
                if (rows.length > 0) {
                    rows.forEach(row => {
                        const country = row.cells[1].textContent.trim();
                        const tradeValue = parseFloat(row.cells[2].textContent.replace('$', '').replace(',', '')) || 1000;
                        const supplier = row.cells[0].textContent.trim();
                        const coords = getCountryCoords(country);
                        if (coords[0] !== 0 || coords[1] !== 0) {
                            const radius = Math.min(20, tradeValue / 1000) || 5;
                            L.circleMarker(coords, {
                                color: '#00FFCC',
                                fillColor: '#00FFCC',
                                fillOpacity: 0.5,
                                radius: radius
                            }).addTo(map).bindTooltip(`<b>${supplier}</b><br>Trade Value: $${tradeValue.toLocaleString()}<br>Country: ${country}`, {
                                permanent: false,
                                direction: 'top',
                                className: 'map-tooltip'
                            }).on('click', () => {
                                alert(`Supplier: ${supplier}\nTrade Value: $${tradeValue.toLocaleString()}\nCountry: ${country}`);
                            });
                        }
                    });
                    map.fitBounds(rows.map(row => getCountryCoords(row.cells[1].textContent.trim())).filter(coord => coord[0] !== 0 || coord[1] !== 0));
                }
            }
        }
        window.updateMap = updateMap;

        // Country coordinates
        function getCountryCoords(country) {
            const coords = {
                'China': [35.8617, 104.1954],
                'Vietnam': [14.0583, 108.2772],
                'Mexico': [23.6345, -102.5528],
                'Brazil': [-14.2350, -51.9253],
                'Thailand': [15.8700, 100.9925],
                'India': [20.5937, 78.9629],
                'USA': [37.0902, -95.7129],
                'default': [0, 0]
            };
            return coords[country] || coords['default'];
        }
        window.getCountryCoords = getCountryCoords;

        function searchImports() {
            const query = document.getElementById('importsInput').value.toLowerCase().trim().replace('ing', '');
            const countryFilter = document.getElementById('countryFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const results = document.getElementById('importsResults');
            results.innerHTML = '<div class="loading">Searching...</div>';

            if (!query) {
                results.innerHTML = '<div class="result-item">Enter a company name.</div>';
                return;
            }

            useMockImports(query, countryFilter, yearFilter, results);
        }
        window.searchImports = searchImports;

        function useMockImports(query, countryFilter, yearFilter, results) {
            const mockSuppliers = {
                'acme imports': [
                    { supplier: 'Global Supply Co.', country: 'China', tradeValue: '$5000', year: '2023', product: 'Machinery Parts' },
                    { supplier: 'East Trade Ltd.', country: 'Vietnam', tradeValue: '$3000', year: '2022', product: 'Machinery Parts' }
                ],
                'coca-cola': [
                    { supplier: 'Beverage Logistics Inc.', country: 'Mexico', tradeValue: '$10000', year: '2023', product: 'Soft Drinks' },
                    { supplier: 'Sweet Water Suppliers', country: 'Brazil', tradeValue: '$7500', year: '2022', product: 'Soft Drinks' },
                    { supplier: 'Pacific Beverage Corp.', country: 'China', tradeValue: '$6000', year: '2023', product: 'Soft Drinks' }
                ],
                'monsterenergy': [
                    { supplier: 'Energy Pack Ltd.', country: 'Thailand', tradeValue: '$4000', year: '2023', product: 'Energy Drinks' },
                    { supplier: 'Asia Energy Import', country: 'India', tradeValue: '$2500', year: '2022', product: 'Energy Drinks' }
                ],
                'pepsi cola': [
                    { supplier: 'Sample Supplier', country: 'USA', tradeValue: '$1000', year: '2023', product: 'Miscellaneous' }
                ],
                'default': [
                    { supplier: 'Sample Supplier', country: 'USA', tradeValue: '$1000', year: '2023', product: 'Miscellaneous' }
                ]
            };

            const suppliers = mockSuppliers[query] || mockSuppliers['default'];
            let tableHTML = `
                <div class="summary-box">Trade Insights for ${query.toUpperCase()} | Last Updated: ${new Date().toLocaleDateString()} | <a href="plans.html" class="btn">Upgrade for Full Report</a></div>
                <table class="result-table">
                    <tr>
                        <th onclick="sortTable(0)">Supplier</th>
                        <th onclick="sortTable(1)">Country</th>
                        <th onclick="sortTable(2)">Trade Value</th>
                        <th onclick="sortTable(3)">Year</th>
                        <th onclick="sortTable(4)">Product</th>
                        <th>Action</th>
                    </tr>
            `;
            const filteredSuppliers = suppliers.filter(supplier => {
                const matchesCountry = !countryFilter || supplier.country === countryFilter;
                const matchesYear = !yearFilter || supplier.year === yearFilter;
                return matchesCountry && matchesYear;
            });
            const totalResults = suppliers.length;

            if (filteredSuppliers.length > 0 && (isTestMode || auth.currentUser || isPremium)) {
                filteredSuppliers.slice(0, 3).forEach(supplier => {
                    tableHTML += `
                        <tr>
                            <td>${supplier.supplier}</td>
                            <td>${supplier.country}</td>
                            <td>${supplier.tradeValue}</td>
                            <td>${supplier.year}</td>
                            <td>${supplier.product}</td>
                            <td><button class="btn premium" onclick="viewReport()">View Report (Premium)</button></td>
                        </tr>
                    `;
                });
                tableHTML += `<p style="color: #A0AEC0; text-align: center;">Showing ${Math.min(3, filteredSuppliers.length)} of ${totalResults} results</p>`;
                if (totalResults > 3) {
                    tableHTML += `<div class="premium-note">Upgrade to see all ${totalResults} results</div><div class="pagination"></div>`;
                }
            } else {
                tableHTML += '<tr><td colspan="6">No supplier records found with current filters.</td></tr>';
            }
            tableHTML += '</table>';
            results.innerHTML = tableHTML;
            updatePagination();
            updateMap();
        }
        window.useMockImports = useMockImports;

        // View Report function with premium content
        function viewReport() {
            if (!isPremium && !isTestMode) {
                alert('This feature requires a Business/Enterprise plan. Upgrade to access full reports.');
                window.location.href = 'plans.html';
            } else {
                alert('Full report: Detailed supplier analysis, trade history, and contact info available. Visit plans.html for more!');
            }
        }
        window.viewReport = viewReport;

        // Placeholder for visual tour
        function startTour() {
            alert('Visual tour coming soon! This will showcase examples of lead hunting results.');
        }
        window.startTour = startTour;

        // Smooth scroll for CTAs
        document.querySelectorAll('a.btn, button.btn').forEach(btn => {
            if (btn.textContent.includes('Get Started') || btn.textContent.includes('Sign Up')) {
                btn.addEventListener('click', () => {
                    window.location.href = 'plans.html';
                });
            }
        });
    </script>
    <style>
        .map-tooltip { background: #2D3748; color: #E2E8F0; border: 1px solid #4A5568; border-radius: 4px; padding: 5px; }
        .no-data-icon { background: #FC8181; color: #E2E8F0; padding: 5px; border-radius: 50%; text-align: center; }
    </style>
</body>
</html>