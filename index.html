<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaHunt - AI Lead Hunter</title>
    <meta name="description" content="NovaHunt.ai: AI-powered tool to hunt B2B leads, emails, and suppliers with precision.">
    <meta name="keywords" content="AI lead generation, B2B leads, email hunter, supplier finder">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¥·</text></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=1.1.2" />
    <style>
        /* [Existing styles remain unchanged] */
    </style>
</head>
<body>
    <section class="section" style="padding-top: 80px; background: #1A202C; box-shadow: 0 4px 20px rgba(0, 255, 204, 0.3);">
        <div class="container">
            <h1>ðŸ¥· NovaHunt</h1>
            <p style="font-size: 1.2em;">AI-Powered Lead Generation That Hunts for You</p>
            <p>Redefine B2B success with cutting-edge AI precision.</p>
            <div style="text-align: center; margin-top: 20px;">
                <a href="https://buy.stripe.com/test_3cI7sLbl5dgI1ma5TL00002" class="btn btn-primary">Subscribe to Pro ($29/month)</a>
                <a href="https://buy.stripe.com/test_aFacN59cX0tWgh4ci900001" class="btn btn-primary">Business ($59/month)</a>
                <a href="https://buy.stripe.com/test_fZu5kD88T3G85Cqbe500000" class="btn btn-primary">Enterprise ($99/month)</a>
            </div>
            <p style="font-size: 0.9em; color: #90CDF4;">Free credits â€¢ No credit card required</p>
            <div class="test-mode-toggle">
                <input type="checkbox" id="testMode" onchange="toggleTestMode()">
                <label for="testMode">Enable Test Mode (Business/Enterprise Access)</label>
            </div>
        </div>
    </section>

    <div class="nav" id="navLinks"></div>

    <section class="section">
        <div class="container">
            <h2>Search for Leads</h2>
            <p>Unleash NovaHuntâ€™s power across multiple modes.</p>
            <div class="search-tabs">
                <button class="tab-btn active" onclick="switchTab('company', this)">Hunt Corporate Emails</button>
                <button class="tab-btn" onclick="switchTab('ai', this)">Hunt Industry Leads</button>
                <button class="tab-btn" onclick="switchTab('imports', this)">Hunt Import Records</button>
            </div>
            <div id="company-tab" class="tab-content active">
                <p style="text-align: center; opacity: 0.8;">Enter a company name or domain (e.g., coca-cola.com).</p>
                <input type="text" id="companyInput" placeholder="Company or domain..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0;">
                <div id="companyError" class="error" style="display: none;"></div>
                <button class="btn-primary" onclick="searchCompany()">Find Emails & Contacts</button>
                <div id="companyResults" class="results"></div>
            </div>
            <div id="ai-tab" class="tab-content">
                <!-- Populated by checkAccess -->
            </div>
            <div id="imports-tab" class="tab-content">
                <!-- Populated by checkAccess -->
            </div>
        </div>
    </section>

    <button class="tour-btn" onclick="startTour()">Take a Tour</button>

    <footer style="text-align: center; padding: 20px 0; color: #A0AEC0; font-size: 0.9em;">
        Â© 2025 NovaHunt.ai | All rights reserved | <a href="terms.html" style="color: #90CDF4; text-decoration: none;">Terms of Service</a> | <a href="privacy.html" style="color: #90CDF4; text-decoration: none;">Privacy Policy</a> | <a href="faq.html" style="color: #90CDF4; text-decoration: none;">FAQ</a>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=1.1.2"></script>
    <script>
        // Initialize global variables FIRST
        let userCredits = 5;
        let isPremium = false;
        let isTestMode = false;
        let map;
        let currentUser = null;

        // Global Firebase setup
        const firebaseConfig = {
            apiKey: "AIzaSyArKU9HQx7An_PhRM2jlzIHVnLp1EmISlA",
            authDomain: "novahunt-web-app-v2.firebaseapp.com",
            projectId: "novahunt-web-app-v2",
            storageBucket: "novahunt-web-app-v2.firebasestorage.app",
            messagingSenderId: "915754711081",
            appId: "1:915754711081:web:f563cc734c901812954438"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Update UI based on auth state
        function updateUI(user) {
            const navLinks = document.getElementById('navLinks');
            currentUser = user; // Store current user globally
            
            if (user) {
                navLinks.innerHTML = `
                    <div class="user-info">Logged in as: ${user.email}</div>
                    <button class="btn" onclick="logout()">Logout</button>
                `;
            } else {
                navLinks.innerHTML = `
                    <a href="login.html" class="btn">Sign In</a> 
                    <a href="signup.html" class="btn">Sign Up</a>
                `;
            }
            
            // Always call checkAccess after UI update
            checkAccess();
        }

        // Update UI based on auth state with debug log
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed, user:', user ? 'logged in' : 'not logged in');
            currentUser = user; // Update global user
            
            if (user) {
                try {
                    await checkSubscriptionStatus(user.uid);
                    await loadUserCredits(user.uid);
                } catch (error) {
                    console.error('Error loading user data:', error);
                    isPremium = false;
                    userCredits = 5;
                }
            } else {
                // Reset to defaults when not logged in
                isPremium = false;
                userCredits = 5;
                isTestMode = false;
            }
            
            updateUI(user);
        });

        function logout() {
            auth.signOut().then(() => {
                updateUI(null);
                isTestMode = false;
                isPremium = false;
                alert('Logged out successfully!');
            }).catch((error) => alert('Error logging out: ' + error.message));
        }
        window.logout = logout;

        // Toggle test mode
        function toggleTestMode() {
            isTestMode = document.getElementById('testMode').checked;
            console.log(`Test mode ${isTestMode ? 'enabled' : 'disabled'}`);
            alert(`Test mode ${isTestMode ? 'enabled' : 'disabled'}. Premium features ${isTestMode ? 'available' : 'restricted'}.`);
            checkAccess();
        }
        window.toggleTestMode = toggleTestMode;

        async function checkSubscriptionStatus(uid) {
            const userRef = doc(db, 'users', uid);
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isPremium = data.isPremium === true;
                    console.log('Subscription status:', isPremium);
                } else {
                    isPremium = false;
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
                isPremium = false;
            }
        }
        window.checkSubscriptionStatus = checkSubscriptionStatus;

        // Check access for premium sections
        function checkAccess() {
            console.log('checkAccess called - isTestMode:', isTestMode, 'isPremium:', isPremium, 'currentUser:', currentUser);
            
            const aiTab = document.getElementById('ai-tab');
            const importsTab = document.getElementById('imports-tab');
            
            if (!aiTab || !importsTab) {
                console.log('Tab elements not found yet');
                return;
            }
            
            // Show upgrade message if not premium and not test mode
            if (!isTestMode && !isPremium) {
                if (currentUser) {
                    // Logged in but not premium
                    aiTab.innerHTML = '<div class="upgrade-message">This feature is for Business/Enterprise users. <a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade Now</a></div>';
                    importsTab.innerHTML = '<div class="upgrade-message">This feature is for Business/Enterprise users. <a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade Now</a></div>';
                } else {
                    // Not logged in
                    aiTab.innerHTML = '<div class="upgrade-message">Please <a href="login.html" class="btn">Sign In</a> or <a href="signup.html" class="btn">Sign Up</a> to access premium features.</div>';
                    importsTab.innerHTML = '<div class="upgrade-message">Please <a href="login.html" class="btn">Sign In</a> or <a href="signup.html" class="btn">Sign Up</a> to access premium features.</div>';
                }
            } else {
                // Premium access granted - show full functionality
                console.log('Enabling premium features');
                aiTab.innerHTML = `
                    <p style="text-align: center; opacity: 0.8;">Enter a query like 'Ice Cream Companies USA' for live results.</p>
                    <input type="text" id="aiInput" placeholder="AI-powered lead query..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0;">
                    <button class="btn" onclick="searchAI()">Generate Leads</button>
                    <div id="aiResults" class="results"></div>
                `;
                importsTab.innerHTML = `
                    <p style="text-align: center; opacity: 0.8;">Enter a company name</p>
                    <p style="text-align: center; opacity: 0.8; font-weight: 500;">Import Competitors Supplier Records (e.g., acme imports)</p>
                    <div class="filter-group">
                        <select id="countryFilter">
                            <option value="">All Countries</option>
                            <option value="China">China</option>
                            <option value="Vietnam">Vietnam</option>
                            <option value="USA">USA</option>
                        </select>
                        <select id="yearFilter">
                            <option value="">All Years</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                        </select>
                    </div>
                    <input type="text" id="importsInput" placeholder="Company for import search..." style="width: 100%; max-width: 400px; margin: 0 auto 10px; display: block; padding: 10px; border: 1px solid #4A5568; border-radius: 4px; background: #1A202C; color: #E2E8F0;">
                    <button class="btn" onclick="searchImports()">Find Suppliers</button>
                    <div id="importsResults" class="results"></div>
                    <div id="map"><div class="map-placeholder">Waiting for search results to display competitor suppliers...</div></div>
                `;
            }
        }
        window.checkAccess = checkAccess;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing UI');
            updateUI(auth.currentUser);
            checkAccess();
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('onclick').match(/switchTab\('([^']+)'/)[1];
                    switchTab(tabName, e.target);
                });
            });
        });

        function initMap() {
            const mapDiv = document.getElementById('map');
            if (mapDiv && mapDiv.offsetParent !== null) {
                if (!map) {
                    map = L.map('map').setView([20, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(map);
                    map.getContainer().style.background = '#1A202C';
                }
            }
        }
        window.initMap = initMap;

        function switchTab(tabName, button) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(btn => btn.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            if (tabName === 'imports' && (isTestMode || isPremium)) {
                initMap();
                if (document.getElementById('importsResults').innerHTML.includes('table')) updateMap();
            }
            console.log(`Switched to ${tabName} tab`);
        }
        window.switchTab = switchTab;

        function searchCompany() {
            const query = document.getElementById('companyInput').value.trim();
            const results = document.getElementById('companyResults');
            const errorDiv = document.getElementById('companyError');
            errorDiv.style.display = 'none';

            if (!query.includes('.com') && !query.includes('.org') && !query.includes('.net')) {
                errorDiv.textContent = 'Incorrect format. Please enter a valid domain (e.g., coca-cola.com).';
                errorDiv.style.display = 'block';
                results.innerHTML = '';
                return;
            }

            results.innerHTML = '<div class="loading">Searching...</div>';
            const apiKey = 'b2eb114113547c1eeb296f358fb10653acc0727a';
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://api.hunter.io/v2/domain-search?domain=${encodeURIComponent(query)}&api_key=${apiKey}`;
            fetch(proxyUrl + encodeURIComponent(apiUrl))
                .then(response => response.json())
                .then(data => {
                    results.innerHTML = '';
                    const mockTotal = (query === 'coca-cola.com') ? 444 : (query === 'monsterenergy.com' ? 45 : data.data.emails.length);
                    results.innerHTML += `<p style="color: #A0AEC0;">Found ${mockTotal} emails across departments.</p>`;
                    const emailsByDept = {};
                    (data.data.emails || []).slice(0, 10).forEach(email => {
                        const dept = email.department || 'Unknown';
                        if (!emailsByDept[dept]) emailsByDept[dept] = [];
                        emailsByDept[dept].push(email);
                    });
                    for (const [dept, emails] of Object.entries(emailsByDept)) {
                        results.innerHTML += `<div class="department-header">${dept} (${emails.length})</div>`;
                        emails.slice(0, 10).forEach(email => {
                            const name = `${email.first_name || ''} ${email.last_name || ''}`.trim() || 'N/A';
                            const role = email.position || 'N/A';
                            const confidence = email.confidence || 'N/A';
                            const maskedEmail = `********@${query.split('.')[0]}.com`;
                            results.innerHTML += `
                                <div class="result-item">
                                    <h3>${name}</h3>
                                    <p class="result-desc">Role: ${role}</p>
                                    <p class="email">${maskedEmail} <button class="btn" onclick="revealEmail('${email.value}', this, 1)">Reveal (1 Credit)</button> | Confidence: ${confidence}%</p>
                                </div>
                            `;
                        });
                    }
                    if (!isPremium && !isTestMode && currentUser) {
                        results.innerHTML += `<div class="premium-note"><a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade to See All ${mockTotal - 10} Additional Emails</a></div>`;
                    } else if (!isPremium && !isTestMode && !currentUser) {
                        results.innerHTML += '<div class="premium-note">Please log in or sign up to reveal emails. <a href="login.html" class="btn btn-inline">Log In</a> <a href="signup.html" class="btn btn-inline">Sign Up</a></div>';
                    }
                })
                .catch(err => {
                    console.error('API fetch failed:', err);
                    results.innerHTML = `<div class="result-item">API Error: ${err.message}. Showing mock data for ${query}...</div>`;
                    const mockTotal = (query === 'coca-cola.com') ? 444 : (query === 'monsterenergy.com' ? 45 : 10);
                    results.innerHTML += `<p style="color: #A0AEC0;">Mock data: Found ${mockTotal} emails across departments.</p>`;
                    const mockEmails = [
                        { name: 'Jane Smith', role: 'Marketing Manager', email: 'jane.smith@' + query.split('.')[0] + '.com', dept: 'Marketing', confidence: 80 },
                        { name: 'Mike Johnson', role: 'Sales Director', email: 'mike.johnson@' + query.split('.')[0] + '.com', dept: 'Sales', confidence: 85 }
                    ];
                    const mockEmailsByDept = {};
                    mockEmails.forEach(email => {
                        if (!mockEmailsByDept[email.dept]) mockEmailsByDept[email.dept] = [];
                        mockEmailsByDept[email.dept].push(email);
                    });
                    for (const [dept, emails] of Object.entries(mockEmailsByDept)) {
                        results.innerHTML += `<div class="department-header">${dept} (${emails.length})</div>`;
                        emails.forEach(email => {
                            const maskedEmail = `********@${query.split('.')[0]}.com`;
                            results.innerHTML += `
                                <div class="result-item">
                                    <h3>${email.name}</h3>
                                    <p class="result-desc">Role: ${email.role}</p>
                                    <p class="email">${maskedEmail} <button class="btn" onclick="revealEmail('${email.email}', this, 1)">Reveal (1 Credit)</button> | Confidence: ${email.confidence}%</p>
                                </div>
                            `;
                        });
                    }
                    if (!isPremium && !isTestMode && !currentUser) {
                        results.innerHTML += '<div class="premium-note">Please log in or sign up to reveal emails. <a href="login.html" class="btn btn-inline">Log In</a> <a href="signup.html" class="btn btn-inline">Sign Up</a></div>';
                    } else if (!isPremium && !isTestMode) {
                        results.innerHTML += `<div class="premium-note"><a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade to See All ${mockTotal - 2} Additional Emails</a></div>`;
                    }
                });
        }
        window.searchCompany = searchCompany;

        // Load user credits from Firestore
        async function loadUserCredits(uid) {
            const userRef = doc(db, 'users', uid);
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log('User data from Firestore:', data);
                    
                    // Check for enterprise plan (250 credits)
                    if (data.isPremium && data.plan === 'enterprise') {
                        if (data.monthlyCredits && data.monthlyCredits.month === currentMonth) {
                            userCredits = data.monthlyCredits.credits;
                        } else {
                            userCredits = 250; // Enterprise gets 250 credits
                            await setDoc(userRef, { 
                                monthlyCredits: { month: currentMonth, credits: userCredits } 
                            }, { merge: true });
                        }
                        console.log('Enterprise user detected, credits:', userCredits);
                    } 
                    // Check for other premium plans (100 credits)
                    else if (data.isPremium) {
                        if (data.monthlyCredits && data.monthlyCredits.month === currentMonth) {
                            userCredits = data.monthlyCredits.credits;
                        } else {
                            userCredits = 100; // Premium gets 100 credits
                            await setDoc(userRef, { 
                                monthlyCredits: { month: currentMonth, credits: userCredits } 
                            }, { merge: true });
                        }
                        console.log('Premium user detected, credits:', userCredits);
                    } 
                    // Free tier (5 credits)
                    else {
                        if (data.monthlyCredits && data.monthlyCredits.month === currentMonth) {
                            userCredits = data.monthlyCredits.credits;
                        } else {
                            userCredits = 5; // Free gets 5 credits
                            await setDoc(userRef, { 
                                monthlyCredits: { month: currentMonth, credits: userCredits } 
                            }, { merge: true });
                        }
                        console.log('Free user detected, credits:', userCredits);
                    }
                } else {
                    console.log('No user document found, creating new free user');
                    userCredits = 5;
                    await setDoc(userRef, { 
                        isPremium: false,
                        plan: 'free',
                        monthlyCredits: { month: currentMonth, credits: userCredits } 
                    });
                }
            } catch (error) {
                console.error('Error loading credits:', error);
                userCredits = 5;
            }
            return userCredits;
        }
        window.loadUserCredits = loadUserCredits;

        // Reveal email function
        async function revealEmail(email, button, cost) {
            const user = auth.currentUser;
            if (user) {
                await loadUserCredits(user.uid);
                if (userCredits >= cost) {
                    userCredits -= cost;
                    
                    // Update Firestore with new credit count
                    const userRef = doc(db, 'users', user.uid);
                    const now = new Date();
                    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    
                    await setDoc(userRef, { 
                        monthlyCredits: { month: currentMonth, credits: userCredits } 
                    }, { merge: true });
                    
                    button.parentElement.innerHTML = email + ` | Credits left: ${userCredits}`;
                    alert(`Email revealed! ${userCredits} credits remaining this month.`);
                } else {
                    alert('Not enough credits this month. Upgrade to reveal more emails.');
                    window.location.href = 'https://buy.stripe.com/6oE8xJ4cK8d4dEdg7';
                }
            } else {
                alert('Please log in to reveal emails.');
            }
        }
        window.revealEmail = revealEmail;

        function searchAI() {
            const query = document.getElementById('aiInput').value.trim().toLowerCase().replace('stores', 'companies');
            const results = document.getElementById('aiResults');
            results.innerHTML = '<div class="loading">Searching...</div>';
            if (!query) {
                results.innerHTML = '<div class="result-item">Enter a query.</div>';
                return;
            }
            const ocApiUrl = `https://api.opencorporates.com/v0.4/companies/search?q=${encodeURIComponent(query)}&per_page=5`;
            fetch(ocApiUrl)
                .then(response => response.json())
                .then(data => {
                    results.innerHTML = '';
                    if (!data.results || data.results.companies.length === 0) throw new Error('No companies from OpenCorporates');
                    data.results.companies.slice(0, 2).forEach(company => {
                        const name = company.company.name || 'N/A';
                        const url = company.company.company_number ? `https://opencorporates.com/companies/${company.company.jurisdiction_code}/${company.company.company_number}` : '#';
                        results.innerHTML += `<div class="result-item"><h3>${name}</h3><a href="${url}" target="_blank" class="btn">View Profile</a></div>`;
                    });
                    if (!isPremium && !isTestMode) {
                        results.innerHTML += `<div class="premium-note"><a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade to See All ${data.results.companies.length - 2} Additional Companies</a></div>`;
                    }
                })
                .catch(err => {
                    console.error('OpenCorporates failed, falling back to DuckDuckGo:', err);
                    const ddApiUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent('list of ' + query + ' site:*.com -inurl:(signup | login)')}&format=json`;
                    fetch(ddApiUrl)
                        .then(response => response.json())
                        .then(data => {
                            results.innerHTML = '';
                            if (!data.RelatedTopics || data.RelatedTopics.length === 0) {
                                results.innerHTML = '<div class="result-item">No companies found. Showing mock data for ' + query + '...</div>';
                                const mockCompanies = [
                                    { name: 'Ice Cream Co. USA', url: 'https://example.com/icecreamusa' },
                                    { name: 'Frosty Treats Inc.', url: 'https://example.com/frostytreats' }
                                ];
                                mockCompanies.forEach(company => {
                                    results.innerHTML += `<div class="result-item"><h3>${company.name}</h3><a href="${company.url}" target="_blank" class="btn">View Profile</a></div>`;
                                });
                                if (!isPremium && !isTestMode) {
                                    results.innerHTML += '<div class="premium-note"><a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade to See All 142 Additional Companies</a></div>';
                                }
                            } else {
                                data.RelatedTopics.slice(0, 2).forEach(topic => {
                                    const name = topic.Text || 'N/A';
                                    const url = topic.FirstURL || '#';
                                    results.innerHTML += `<div class="result-item"><h3>${name}</h3><a href="${url}" target="_blank" class="btn">View Profile</a></div>`;
                                });
                                if (!isPremium && !isTestMode) {
                                    results.innerHTML += `<div class="premium-note"><a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade to See All ${data.RelatedTopics.length - 2} Additional Companies</a></div>';
                                }
                            }
                        })
                        .catch(ddErr => {
                            results.innerHTML = '<div class="result-item">Error: Both APIs failed. Showing mock data for ' + query + '...</div>';
                            const mockCompanies = [
                                { name: 'Ice Cream Co. USA', url: 'https://example.com/icecreamusa' },
                                { name: 'Frosty Treats Inc.', url: 'https://example.com/frostytreats' }
                            ];
                            mockCompanies.forEach(company => {
                                results.innerHTML += `<div class="result-item"><h3>${company.name}</h3><a href="${company.url}" target="_blank" class="btn">View Profile</a></div>`;
                            });
                            if (!isPremium && !isTestMode) {
                                results.innerHTML += '<div class="premium-note"><a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade to See All 142 Additional Companies</a></div>';
                            }
                            console.error('DuckDuckGo fallback failed:', ddErr);
                        });
                });
        }
        window.searchAI = searchAI;

        let sortDirection = 1;
        let currentPage = 1;
        const itemsPerPage = 3;

        function sortTable(columnIndex) {
            const table = document.querySelector('#importsResults table');
            const rows = Array.from(table.querySelectorAll('tr')).slice(1);
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent;
                const bValue = b.cells[columnIndex].textContent;
                return aValue.localeCompare(bValue, undefined, { numeric: true }) * sortDirection;
            });
            rows.forEach(row => table.appendChild(row));
            sortDirection *= -1;
            updatePagination();
            updateMap();
        }
        window.sortTable = sortTable;

        function updatePagination() {
            const table = document.querySelector('#importsResults table');
            const rows = Array.from(table.querySelectorAll('tr')).slice(1);
            const totalPages = Math.ceil(rows.length / itemsPerPage);
            const pagination = document.querySelector('.pagination');
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.addEventListener('click', () => {
                    currentPage = i;
                    displayPage();
                });
                if (i === currentPage) button.classList.add('active');
                pagination.appendChild(button);
            }
            displayPage();
        }
        window.updatePagination = updatePagination;

        function displayPage() {
            const table = document.querySelector('#importsResults table');
            const rows = Array.from(table.querySelectorAll('tr')).slice(1);
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            rows.forEach((row, index) => {
                row.style.display = (index >= start && index < end) ? '' : 'none';
            });
            updateMap();
        }
        window.displayPage = displayPage;

        function updateMap() {
            if (!map) initMap();
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.CircleMarker) map.removeLayer(layer);
            });
            const table = document.querySelector('#importsResults table');
            if (table) {
                const rows = Array.from(table.querySelectorAll('tr')).slice(1).filter(row => row.style.display !== 'none');
                if (rows.length > 0) {
                    rows.forEach(row => {
                        const country = row.cells[1].textContent.trim();
                        const tradeValue = parseFloat(row.cells[2].textContent.replace('$', '').replace(',', '')) || 1000;
                        const supplier = row.cells[0].textContent.trim();
                        const coords = getCountryCoords(country);
                        if (coords[0] !== 0 || coords[1] !== 0) {
                            const radius = Math.min(20, tradeValue / 1000) || 5;
                            L.circleMarker(coords, {
                                color: '#00FFCC',
                                fillColor: '#00FFCC',
                                fillOpacity: 0.5,
                                radius: radius
                            }).addTo(map).bindTooltip(`<b>${supplier}</b><br>Trade Value: $${tradeValue.toLocaleString()}<br>Country: ${country}`, {
                                permanent: false,
                                direction: 'top',
                                className: 'map-tooltip'
                            }).on('click', () => {
                                alert(`Supplier: ${supplier}\nTrade Value: $${tradeValue.toLocaleString()}\nCountry: ${country}`);
                            });
                        }
                    });
                    map.fitBounds(rows.map(row => getCountryCoords(row.cells[1].textContent.trim())).filter(coord => coord[0] !== 0 || coord[1] !== 0));
                } else {
                    console.log('No visible rows to plot on map');
                }
            } else {
                console.log('No table found for map update');
            }
        }
        window.updateMap = updateMap;

        function getCountryCoords(country) {
            const coords = {
                'China': [35.8617, 104.1954],
                'Vietnam': [14.0583, 108.2772],
                'Mexico': [23.6345, -102.5528],
                'Brazil': [-14.2350, -51.9253],
                'Thailand': [15.8700, 100.9925],
                'India': [20.5937, 78.9629],
                'USA': [37.0902, -95.7129],
                'default': [0, 0]
            };
            return coords[country] || coords['default'];
        }
        window.getCountryCoords = getCountryCoords;

        function searchImports() {
            const query = document.getElementById('importsInput').value.toLowerCase().trim().replace('ing', '');
            const countryFilter = document.getElementById('countryFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const results = document.getElementById('importsResults');
            results.innerHTML = '<div class="loading">Searching...</div>';

            if (!query) {
                results.innerHTML = '<div class="result-item">Enter a company name.</div>';
                return;
            }

            const mockSuppliers = {
                'acme imports': [
                    { supplier: 'Global Supply Co.', country: 'China', tradeValue: '$5000', year: '2023', product: 'Machinery Parts' },
                    { supplier: 'East Trade Ltd.', country: 'Vietnam', tradeValue: '$3000', year: '2022', product: 'Machinery Parts' }
                ],
                'coca-cola': [
                    { supplier: 'Beverage Logistics Inc.', country: 'Mexico', tradeValue: '$10000', year: '2023', product: 'Soft Drinks' },
                    { supplier: 'Sweet Water Suppliers', country: 'Brazil', tradeValue: '$7500', year: '2022', product: 'Soft Drinks' },
                    { supplier: 'Pacific Beverage Corp.', country: 'China', tradeValue: '$6000', year: '2023', product: 'Soft Drinks' }
                ],
                'monsterenergy': [
                    { supplier: 'Energy Pack Ltd.', country: 'Thailand', tradeValue: '$4000', year: '2023', product: 'Energy Drinks' },
                    { supplier: 'Asia Energy Import', country: 'India', tradeValue: '$2500', year: '2022', product: 'Energy Drinks' }
                ],
                'pepsi cola': [
                    { supplier: 'Sample Supplier', country: 'USA', tradeValue: '$1000', year: '2023', product: 'Miscellaneous' }
                ],
                'default': [
                    { supplier: 'Sample Supplier', country: 'USA', tradeValue: '$1000', year: '2023', product: 'Miscellaneous' }
                ]
            };

            const suppliers = mockSuppliers[query] || mockSuppliers['default'];
            let tableHTML = `
                <div class="summary-box">Trade Insights for ${query.toUpperCase()} | Last Updated: ${new Date().toLocaleDateString()} | <a href="https://buy.stripe.com/6oE8xJ4cK8d4dEdg7" class="btn">Upgrade for Full Report</a></div>
                <table class="result-table">
                    <tr>
                        <th onclick="sortTable(0)">Supplier</th>
                        <th onclick="sortTable(1)">Country</th>
                        <th onclick="sortTable(2)">Trade Value</th>
                        <th onclick="sortTable(3)">Year</th>
                        <th onclick="sortTable(4)">Product</th>
                        <th>Action</th>
                    </tr>
            `;
            const filteredSuppliers = suppliers.filter(supplier => {
                const matchesCountry = !countryFilter || supplier.country === countryFilter;
                const matchesYear = !yearFilter || supplier.year === yearFilter;
                return matchesCountry && matchesYear;
            });
            const totalResults = suppliers.length;

            if (filteredSuppliers.length > 0 && (isTestMode || isPremium)) {
                filteredSuppliers.slice(0, 3).forEach(supplier => {
                    tableHTML += `
                        <tr>
                            <td>${supplier.supplier}</td>
                            <td>${supplier.country}</td>
                            <td>${supplier.tradeValue}</td>
                            <td>${supplier.year}</td>
                            <td>${supplier.product}</td>
                            <td><button class="btn premium" onclick="viewReport()">View Report (Premium)</button></td>
                        </tr>
                    `;
                });
                tableHTML += `<p style="color: #A0AEC0; text-align: center;">Showing ${Math.min(3, filteredSuppliers.length)} of ${totalResults} results</p>`;
                if (totalResults > 3) {
                    tableHTML += `<div class="premium-note">Upgrade to see all ${totalResults} results</div><div class="pagination"></div>`;
                }
            } else {
                tableHTML += '<tr><td colspan="6">No supplier records found with current filters.</td></tr>';
            }
            tableHTML += '</table>';
            results.innerHTML = tableHTML;
            updatePagination();
            updateMap();
        }
        window.searchImports = searchImports;

        function viewReport() {
            if (!isPremium && !isTestMode) {
                alert('This feature requires a Business/Enterprise plan. Upgrade to access full reports.');
                window.location.href = 'https://buy.stripe.com/6oE8xJ4cK8d4dEdg7';
            } else {
                alert('Full report: Detailed supplier analysis, trade history, and contact info available. Visit plans.html for more!');
            }
        }
        window.viewReport = viewReport;

        function startTour() {
            let step = 1;
            const steps = [
                "Welcome to NovaHunt! This tour will showcase premium features.",
                "Use 'Hunt Corporate Emails' to find emails (e.g., coca-cola.com).",
                "Try 'Hunt Industry Leads' for industry-specific leads (e.g., 'Ice Cream Companies USA').",
                "Explore 'Hunt Import Records' for supplier data with the map (e.g., acme imports).",
                "Toggle 'Test Mode' to simulate premium access. Sign up for the full experience!",
                "End of tour! Visit plans.html to upgrade."
            ];
            alert(steps[step - 1]);
            const interval = setInterval(() => {
                if (step < steps.length) {
                    step++;
                    alert(steps[step - 1]);
                } else {
                    clearInterval(interval);
                }
            }, 3000);
        }
        window.startTour = startTour;
    </script>
</body>
</html>